<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/head.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.3.0">


  <link rel="mask-icon" href="/images/head.png?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="使用VideoToolbox编码和解码H.264。这篇文章就是在学习WWDC 2014 513 Direct Access to Video Encoding and Decoding的过程中写下。 在刚开始看这个视频的时候发现很不能理解，也参考的大量的博客、文章，最后才将概念一一理清，建议刚开始学习VideoToolbox的同学，可以边看视频，边看这个文章。但是这篇文章并不是按照视频的进度写的，">
<meta name="keywords" content="iOS,Objective-C,Swift 3.2.0,⭐️⭐️⭐️⭐️⭐️">
<meta property="og:type" content="article">
<meta property="og:title" content="VideoToolbox">
<meta property="og:url" content="http://xwjack.github.io/2018/01/18/VideoToolbox/index.html">
<meta property="og:site_name" content="Mini灬哆啦">
<meta property="og:description" content="使用VideoToolbox编码和解码H.264。这篇文章就是在学习WWDC 2014 513 Direct Access to Video Encoding and Decoding的过程中写下。 在刚开始看这个视频的时候发现很不能理解，也参考的大量的博客、文章，最后才将概念一一理清，建议刚开始学习VideoToolbox的同学，可以边看视频，边看这个文章。但是这篇文章并不是按照视频的进度写的，">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/3.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/2.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/4.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/5.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/1.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/12.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/13.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/6.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/7.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/16.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/17.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/18.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/19.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/20.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/21.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/23.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/14.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/15.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/8.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/9.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/10.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/11.png">
<meta property="og:updated_time" content="2018-12-10T08:00:19.571Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VideoToolbox">
<meta name="twitter:description" content="使用VideoToolbox编码和解码H.264。这篇文章就是在学习WWDC 2014 513 Direct Access to Video Encoding and Decoding的过程中写下。 在刚开始看这个视频的时候发现很不能理解，也参考的大量的博客、文章，最后才将概念一一理清，建议刚开始学习VideoToolbox的同学，可以边看视频，边看这个文章。但是这篇文章并不是按照视频的进度写的，">
<meta name="twitter:image" content="http://xwjack.github.io/images/2018-01-18-VideoToolbox/3.png">






  <link rel="canonical" href="http://xwjack.github.io/2018/01/18/VideoToolbox/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>VideoToolbox | Mini灬哆啦</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-80240532-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-80240532-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4312600141d9e3d6b344aba925f03a57";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mini灬哆啦</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwjack.github.io/2018/01/18/VideoToolbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mini灬哆啦">
      <meta itemprop="description" content="It's only a matter of time">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mini灬哆啦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">VideoToolbox
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-01-18 14:33:54" itemprop="dateCreated datePublished" datetime="2018-01-18T14:33:54+08:00">2018-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-12-10 16:00:19" itemprop="dateModified" datetime="2018-12-10T16:00:19+08:00">2018-12-10</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/18/VideoToolbox/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count gitment-comments-count" data-xid="/2018/01/18/VideoToolbox/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>使用VideoToolbox编码和解码H.264。这篇文章就是在学习<a href="https://developer.apple.com/videos/play/wwdc2014/513/" target="_blank" rel="noopener">WWDC 2014 513 Direct Access to Video Encoding and Decoding</a>的过程中写下。</p>
<p>在刚开始看这个视频的时候发现很不能理解，也参考的大量的博客、文章，最后才将概念一一理清，建议刚开始学习VideoToolbox的同学，可以边看视频，边看这个文章。但是这篇文章并不是按照视频的进度写的，因为Apple的视频不太适合新手学习，所以做了一些整理，整个部分分为以下几个部分。</p>
<ul>
<li>Common<ul>
<li>Swift语法中使用C的小坑</li>
<li>一些基本的关键词解释。</li>
</ul>
</li>
<li>Decompress &amp;&amp; Compress<ul>
<li>Decompress<ul>
<li>介绍如何将未解码的CMSampleBuffer解码成CVPixelBuffer。</li>
<li>解码参数的设置及注意事项。</li>
</ul>
</li>
<li>Compress<ul>
<li>介绍如何将已经解码的CMSampleBuffer编码成CMSampleBuffer。</li>
<li>编码参数设置及注意事项。</li>
</ul>
</li>
</ul>
</li>
<li>Advance<ul>
<li>Decompress &amp;&amp; Compress<ul>
<li>Decompress<ul>
<li>如何将未解码的H.264数据流封装成未解码的CMSampleBuffer。</li>
</ul>
</li>
<li>Compress<ul>
<li>如何将解码的CMSampleBuffer编码成H.264数据流。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Summary<ul>
<li>VideoToolbox硬编码及硬解码总结。</li>
</ul>
</li>
<li>Refrence<ul>
<li>参考文章及博客。</li>
</ul>
</li>
</ul>
<a id="more"></a>
<p>使用VideoToolbox编码和解码都是很简单的，难的如何处理编解码后的数据，显示？写文件？传输？如果我们仅仅是将捕获的数据进行显示或者写文件，直接使用AVFoundation框架的API就可以做到，而且很简单。如果是网络传输、直播，那么我们就要用到VideoToolbox了。</p>
<h1 id="Common"><a href="#Common" class="headerlink" title="Common"></a>Common</h1><p>下面介绍一下在学习的过程中遇到的比较有难度的通用问题、专有名词等。</p>
<h2 id="Swift中指针转换"><a href="#Swift中指针转换" class="headerlink" title="Swift中指针转换"></a>Swift中指针转换</h2><p>由于VideoToolbox是用C进行编写的，所以在很多调用的时候需要传入自身的指针，并在Callback中拿到自身示例，在OC中比较好解决，但是在Swift中比较繁琐。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 将self转换成指针</span></span><br><span class="line">(__bridge <span class="keyword">void</span> *)(<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 将指针转换成self</span></span><br><span class="line">(__bridge Class*)outputCallbackRefCon</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 将self转换成UnsafeMutableRawPointer</span></span><br><span class="line"><span class="keyword">let</span> selfInstance = <span class="built_in">unsafeBitCast</span>(<span class="keyword">self</span>, to: <span class="type">UnsafeMutableRawPointer</span>.<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 将指针转换成self</span></span><br><span class="line"><span class="comment">/// Conver instance to self</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter pointee: Instance</span></span><br><span class="line"><span class="comment">/// - Returns: Self</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">converInstance</span>&lt;T: AnyObject&gt;<span class="params">(by pointee: UnsafeMutableRawPointer)</span></span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Unmanaged</span>&lt;<span class="type">T</span>&gt;.fromOpaque(pointee).takeUnretainedValue()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> selfInstance: &lt;#<span class="type">T</span>#&gt; = converInstance(by: &lt;#<span class="type">UnsafeMutableRawPointer</span>#&gt;)</span><br></pre></td></tr></table></figure>
<h2 id="Technology"><a href="#Technology" class="headerlink" title="Technology"></a>Technology</h2><p><img src="/images/2018-01-18-VideoToolbox/3.png" alt=""></p>
<h3 id="Core-Video"><a href="#Core-Video" class="headerlink" title="Core Video"></a>Core Video</h3><h4 id="CVPixelBuffer"><a href="#CVPixelBuffer" class="headerlink" title="CVPixelBuffer"></a>CVPixelBuffer</h4><p>A reference to a Core Video pixel buffer object. The pixel buffer stores an image in main memory. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">CVPixelBuffer</span> = <span class="type">CVImageBuffer</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>CVPixelBuffer</code>是存储在内存中的一个未压缩的光栅图像Buffer。</p>
<p>个人理解就是一张未压缩的图片，视频中的一帧。</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/2.png" alt=""></p>
<h3 id="Core-Media"><a href="#Core-Media" class="headerlink" title="Core Media"></a>Core Media</h3><h4 id="CMBlockBuffer"><a href="#CMBlockBuffer" class="headerlink" title="CMBlockBuffer"></a>CMBlockBuffer</h4><p>CMBlockBuffer is the basic way that we wrap arbitrary blocks of data in core media.</p>
<blockquote>
<p><code>CMBlockBuffer</code>是一个任意的Buffer，相当于Buffer中的Any。在管道中压缩视频的时候，就会把它包装成<code>CMBlockBuffer</code>。相当于<code>CMBlockBuffer</code>代表着一个压缩的数据。</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/4.png" alt=""></p>
<h4 id="CMSampleBuffer"><a href="#CMSampleBuffer" class="headerlink" title="CMSampleBuffer"></a>CMSampleBuffer</h4><p>A CMSampleBuffer is a Core Foundation object containing zero or more compressed (or uncompressed) samples of a particular media type (audio, video, muxed, and so on).</p>
<blockquote>
<p>表示<code>CMSampleBuffer</code>可能是一个压缩的数据，也可能是一个未压缩的数据。取决于<code>CMSampleBuffer</code>里面是<code>CMBlockBuffer</code>还是<code>CVPixelBuffer</code>。</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/5.png" alt=""></p>
<h3 id="H-264-amp-amp-H-265"><a href="#H-264-amp-amp-H-265" class="headerlink" title="H.264 &amp;&amp; H.265"></a>H.264 &amp;&amp; H.265</h3><p>两种编码标准，可以理解为编码协议。</p>
<h4 id="H-264"><a href="#H-264" class="headerlink" title="H.264"></a>H.264</h4><p>H.264/AVC 项目意图创建一种视频标准。与旧标准相比，它能够在更低带宽下提供优质视频（换言之，只有 MPEG-2，H.263 或 MPEG-4 第 2 部分的一半带宽或更少），也不增加太多设计复杂度使得无法实现或实现成本过高。另一目的是提供足够的灵活性以在各种应用、网络及系统中使用，包括高、低带宽，高、低视频分辨率，广播，DVD 存储，RTP/IP 网络，以及 ITU-T 多媒体电话系统。<br>H.264/AVC 包含了一系列新的特征，使得它比起以前的编解码器不但能够更有效的进行编码，还能在各种网络环境下的应用中使用。这样的技术基础让 H.264 成为包括 YouTube 在内的在线视频公司采用它作为主要的编解码器，但是使用它并不是一件很轻松的事情，理论上讲使用 H.264 需要交纳不菲的专利费用。</p>
<h4 id="H-265"><a href="#H-265" class="headerlink" title="H.265"></a>H.265</h4><p>高效率视频编码（High Efficiency Video Coding，简称 HEVC）是一种视频压缩标准，被视为是 ITU-T H.264/MPEG-4 AVC 标准的继任者。2004 年开始由 ISO/IEC Moving Picture Experts Group（MPEG）和 ITU-T Video Coding Experts Group（VCEG）作为 ISO/IEC 23008-2 MPEG-H Part 2 或称作 ITU-T H.265 开始制定。第一版的 HEVC/H.265 视频压缩标准在 2013 年 4 月 13 日被接受为国际电信联盟（ITU-T）的正式标准。HEVC 被认为不仅提升视频质量，同时也能达到 H.264/MPEG-4 AVC 两倍之压缩率（等同于同样画面质量下比特率减少了 50%），可支持 4K 分辨率甚至到超高清电视（UHDTV），最高分辨率可达到 8192×4320（8K 分辨率）。</p>
<h3 id="Video-Formatter"><a href="#Video-Formatter" class="headerlink" title="Video Formatter"></a>Video Formatter</h3><p>视频格式，相当于容器，将编码后的数据按照一定格式进行存储。</p>
<table>
<thead>
<tr>
<th>Formatter</th>
<th>Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>AVI</td>
<td>格式（后缀为 .avi）: 它的英文全称为 Audio Video Interleaved ，即音频视频交错格式。它于 1992 年被 Microsoft 公司推出。这种视频格式的优点是图像质量好。由于无损 AVI 可以保存 alpha 通道，经常被我们使用。缺点太多，体积过于庞大，而且更加糟糕的是压缩标准不统一，最普遍的现象就是高版本 Windows 媒体播放器播放不了采用早期编码编辑的 AVI 格式视频，而低版本 Windows 媒体播放器又播放不了采用最新编码编辑的 AVI 格式视频，所以我们在进行一些 AVI 格式的视频播放时常会出现由于视频编码问题而造成的视频不能播放或即使能够播放，但存在不能调节播放进度和播放时只有声音没有图像等一些莫名其妙的问题。</td>
</tr>
<tr>
<td>QuickTime</td>
<td>格式（后缀为 .mov）: 美国 Apple 公司开发的一种视频格式，默认的播放器是苹果的 QuickTime。具有较高的压缩比率和较完美的视频清晰度等特点，并可以保存 alpha 通道。</td>
</tr>
<tr>
<td>MPEG</td>
<td>格式（文件后缀可以是 .mpg .mpeg .mpe .dat .vob .asf .3gp .mp4等) : 它的英文全称为 Moving Picture Experts Group，即运动图像专家组格式，该专家组建于 1988 年，专门负责为 CD 建立视频和音频标准，而成员都是为视频、音频及系统领域的技术专家。MPEG 文件格式是运动图像压缩算法的国际标准。MPEG 格式目前有三个压缩标准，分别是 MPEG－1、MPEG－2、和 MPEG－4 。MPEG－1、MPEG－2 目前已经使用较少，着重介绍 MPEG－4，其制定于 1998 年，MPEG－4 是为了播放流式媒体的高质量视频而专门设计的，以求使用最少的数据获得最佳的图像质量。目前 MPEG-4 最有吸引力的地方在于它能够保存接近于 DVD 画质的小体积视频文件。</td>
</tr>
<tr>
<td>WMV</td>
<td>格式（后缀为.wmv .asf）: 它的英文全称为 Windows Media Video，也是微软推出的一种采用独立编码方式并且可以直接在网上实时观看视频节目的文件压缩格式。WMV 格式的主要优点包括：本地或网络回放,丰富的流间关系以及扩展性等。WMV 格式需要在网站上播放，需要安装 Windows Media Player（ 简称 WMP），很不方便，现在已经几乎没有网站采用了。</td>
</tr>
<tr>
<td>Real Video</td>
<td>格式（后缀为 .rm .rmvb）: Real Networks 公司所制定的音频视频压缩规范称为Real Media。用户可以使用 RealPlayer 根据不同的网络传输速率制定出不同的压缩比率，从而实现在低速率的网络上进行影像数据实时传送和播放。RMVB 格式：这是一种由 RM 视频格式升级延伸出的新视频格式，当然性能上有很大的提升。RMVB 视频也是有着较明显的优势，一部大小为 700 MB 左右的 DVD 影片，如果将其转录成同样品质的 RMVB 格式，其个头最多也就 400 MB 左右。大家可能注意到了，以前在网络上下载电影和视频的时候，经常接触到 RMVB 格式，但是随着时代的发展这种格式被越来越多的更优秀的格式替代，著名的人人影视字幕组在 2013 年已经宣布不再压制 RMVB 格式视频。</td>
</tr>
<tr>
<td>Flash Video</td>
<td>格式（后缀为 .flv）:由 Adobe Flash 延伸出来的的一种流行网络视频封装格式。随着视频网站的丰富，这个格式已经非常普及。</td>
</tr>
<tr>
<td>Matroska</td>
<td>格式（后缀为 .mkv）:是一种新的多媒体封装格式，这个封装格式可把多种不同编码的视频及 16 条或以上不同格式的音频和语言不同的字幕封装到一个 Matroska Media 档内。它也是其中一种开放源代码的多媒体封装格式。Matroska 同时还可以提供非常好的交互功能，而且比 MPEG 的方便、强大。</td>
</tr>
<tr>
<td>MPEG2-TS</td>
<td>格式 (后缀为 .ts)（Transport Stream「传输流」；又称 MTS、TS）是一种传输和存储包含音效、视频与通信协议各种数据的标准格式，用于数字电视广播系统，如 DVB、ATSC、IPTV 等等。MPEG2-TS 定义于 MPEG-2 第一部分，系统（即原来之 ISO/IEC 标准 13818-1 或 ITU-T Rec. H.222.0）。Media Player Classic、VLC 多媒体播放器等软件可以直接播放 MPEG-TS 文件。</td>
</tr>
</tbody>
</table>
<h3 id="FPS-Frames-PerSecond"><a href="#FPS-Frames-PerSecond" class="headerlink" title="FPS(Frames PerSecond)"></a>FPS(Frames PerSecond)</h3><p>每秒刷新的帧数。帧数越高，流畅度就越高。</p>
<h3 id="分辨率-Resolution"><a href="#分辨率-Resolution" class="headerlink" title="分辨率(Resolution)"></a>分辨率(Resolution)</h3><p><a href="http://xwjack.github.io/2018/01/10/Camera/#sessionPreset">Camera</a>中的<code>AVCaptureSessionPreset640x480</code></p>
<h3 id="比特率-Bit-Rate-码流-Data-Rate-码率"><a href="#比特率-Bit-Rate-码流-Data-Rate-码率" class="headerlink" title="比特率(Bit Rate)/码流(Data Rate)/码率"></a>比特率(Bit Rate)/码流(Data Rate)/码率</h3><p>比特率这个词有多种翻译，比如码率等，表示经过编码（压缩）后的音频数据每秒钟需要用多少个比特来表示，而比特就是二进制里面最少的单位，要么是0，要么是1。比特率与音视频压缩的关系简单的说就是比特率越高音视频的质量就越好，但编码后的文件就越大；如果比特率越少则情况刚好相反。</p>
<p>下面是不同类型的比特率编码</p>
<table>
<thead>
<tr>
<th>Title</th>
<th>Raw Title</th>
<th>Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>CBR</td>
<td>Constant Bit Rate</td>
<td>恒定比特率</td>
</tr>
<tr>
<td>VBR</td>
<td>Variable Bit Rate</td>
<td>动态比特率</td>
</tr>
<tr>
<td>MBR</td>
<td>Mutable Bit Rate</td>
<td>多比特率编码</td>
</tr>
</tbody>
</table>
<h3 id="NALU"><a href="#NALU" class="headerlink" title="NALU"></a>NALU</h3><p>H.264 stream consists of a sequence of NAL Units (NALUs)</p>
<p><img src="/images/2018-01-18-VideoToolbox/1.png" alt=""></p>
<blockquote>
<p>H.264码流由一系列NALU单元组成。个人理解就是压缩，传输中最小的数据单元。</p>
</blockquote>
<h3 id="I、B、P-Frames"><a href="#I、B、P-Frames" class="headerlink" title="I、B、P Frames"></a>I、B、P Frames</h3><table>
<thead>
<tr>
<th>Frame</th>
<th>Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>I Frame</td>
<td>I 帧是内部编码帧（也称为关键帧IDR）</td>
</tr>
<tr>
<td>B Frame</td>
<td>B 帧是双向内插帧（双向参考帧）</td>
</tr>
<tr>
<td>P Frame</td>
<td>P 帧是前向预测帧（前向参考帧）</td>
</tr>
</tbody>
</table>
<p>I 帧是一个完整的画面，而 P 帧和 B 帧记录的是相对于 I 帧的变化。如果没有 I 帧，P 帧和 B 帧就无法解码。</p>
<p><img src="/images/2018-01-18-VideoToolbox/12.png" alt="移动直播技术秒开优化经验（含PPT）"></p>
<h3 id="GOP-Group-Of-Picture"><a href="#GOP-Group-Of-Picture" class="headerlink" title="GOP(Group Of Picture)"></a>GOP(Group Of Picture)</h3><p>GOP ( Group of Pictures ) 是一组连续的画面，由一张 I 帧和数张 B / P 帧组成，是视频图像编码器和解码器存取的基本单位，它的排列顺序将会一直重复到影像结束。GOP 体现了关键帧的周期，也就是两个关键帧之间的距离，即一个帧组的最大帧数。假设一个视频的恒定帧率是 24fps（即1秒24帧图像），关键帧周期为 2s，那么一个 GOP 就是 48 张图像。一般而言，每一秒视频至少需要使用一个关键帧。增加关键帧个数可改善画质（GOP 通常为 FPS 的倍数），但是同时增加了带宽和网络负载。</p>
<p><img src="/images/2018-01-18-VideoToolbox/13.png" alt="移动直播技术秒开优化经验（含PPT）"></p>
<blockquote>
<p><a href="https://www.jianshu.com/p/1e14ee263f1a" target="_blank" rel="noopener">移动直播技术秒开优化经验（含PPT）</a></p>
</blockquote>
<h3 id="SPS-amp-amp-PPS"><a href="#SPS-amp-amp-PPS" class="headerlink" title="SPS &amp;&amp; PPS"></a>SPS &amp;&amp; PPS</h3><p>SPS(Sequence Parameter Set)、PPS(Picture Parameter Set). Both entities contain information that an h.264 decoder needs to decode the video data, for example the resolution and frame rate of the video.</p>
<blockquote>
<p>包含视频的信息，例如分辨率、码率等。</p>
<p><a href="https://cardinalpeak.com/blog/the-h-264-sequence-parameter-set/" target="_blank" rel="noopener">The h.264 Sequence Parameter Set</a> <a href="https://www.jianshu.com/p/431819e0b6f1" target="_blank" rel="noopener">SPS &amp; PPS in H.264 详解</a> <a href="https://zhuanlan.zhihu.com/p/27896239" target="_blank" rel="noopener">H264码流中SPS PPS详解</a></p>
</blockquote>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>下面一张图解释了NALU和SPS、PPS、I Frame、B Frame、P Frame之间的关系</p>
<p><img src="/images/2018-01-18-VideoToolbox/6.png" alt=""></p>
<blockquote>
<p>NALU中可以包含视频图像数据(I Frame、P Frame、B Frame或视频帧片段)、SPS、PPS。可能很多个NALU才能组成一帧。</p>
</blockquote>
<p>下面一张图解释了NALU的两种不同的格式Elementary Stream 和 MPEG-4 格式，一个是为了方便传输，一个是为了方便存储。</p>
<p><img src="/images/2018-01-18-VideoToolbox/7.png" alt=""></p>
<blockquote>
<p>顺序播放和随机读取。</p>
</blockquote>
<hr>
<h1 id="Decompress-amp-amp-Compress"><a href="#Decompress-amp-amp-Compress" class="headerlink" title="Decompress &amp;&amp; Compress"></a>Decompress &amp;&amp; Compress</h1><p>下面介绍的是如何用VideoToolbox将未编码的CMSampleBuffer(CVPixelBuffer)与已编码的CMSampleBuffer(CMBlockBuffer)的相互转换。</p>
<h2 id="Decompress"><a href="#Decompress" class="headerlink" title="Decompress"></a>Decompress</h2><p>解码流程：</p>
<ol>
<li>使用<code>VTDecompressionSessionCreate(_:_:_:_:_:_:_:_:_:_:)</code>创建编码会话</li>
<li>使用<code>VTSessionSetProperty(_:_:_:)</code>或者<code>VTSessionSetProperties(_:_:)</code>设置会话参数</li>
<li>使用<code>VTDecompressionSessionDecodeFrame(_:_:_:_:_:_:_:)</code>编码视频帧，在<code>VTDecompressionOutputCallbackRecord</code>得到编码后的结果。</li>
<li>使用<code>VTCompressionSessionCompleteFrames(_:_:)</code>来强制结束并完成编码。</li>
<li>编码完成之后使用<code>VTCompressionSessionInvalidate(_:)</code>结束编码，并释放内存。</li>
</ol>
<blockquote>
<p>这里的<code>VTDecompressionOutputCallbackRecord</code>是一个struct</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/16.png" alt=""></p>
<h3 id="VTDecompressionSession"><a href="#VTDecompressionSession" class="headerlink" title="VTDecompressionSession"></a>VTDecompressionSession</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTDecompressionSessionCreate</span></span><br><span class="line"><span class="comment">	@abstract	Creates a session for decompressing video frames.</span></span><br><span class="line"><span class="comment">    @discussion </span></span><br><span class="line"><span class="comment">		Decompressed frames will be emitted through calls to outputCallback.</span></span><br><span class="line"><span class="comment">	@param	allocator</span></span><br><span class="line"><span class="comment">		An allocator for the session.  Pass NULL to use the default allocator.</span></span><br><span class="line"><span class="comment">	@param	videoFormatDescription</span></span><br><span class="line"><span class="comment">		Describes the source video frames.</span></span><br><span class="line"><span class="comment">	@param	videoDecoderSpecification</span></span><br><span class="line"><span class="comment">		Specifies a particular video decoder that must be used.  </span></span><br><span class="line"><span class="comment">		Pass NULL to let the video toolbox choose a decoder.</span></span><br><span class="line"><span class="comment">	@param	destinationImageBufferAttributes</span></span><br><span class="line"><span class="comment">		Describes requirements for emitted pixel buffers.</span></span><br><span class="line"><span class="comment">		Pass NULL to set no requirements.</span></span><br><span class="line"><span class="comment">	@param	outputCallback</span></span><br><span class="line"><span class="comment">		The callback to be called with decompressed frames.</span></span><br><span class="line"><span class="comment">		Pass NULL if and only if you will be calling VTDecompressionSessionDecodeFrameWithOutputHandler for decoding frames.</span></span><br><span class="line"><span class="comment">	@param	decompressionSessionOut</span></span><br><span class="line"><span class="comment">		Points to a variable to receive the new decompression session.</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 创建解码会话</span></span><br><span class="line"><span class="type">VTDecompressionSessionCreate</span>(<span class="literal">nil</span>, videoFormatDescription!, <span class="literal">nil</span>, destinationImageBufferAttributes, &amp;record, &amp;deCompressSession)</span><br></pre></td></tr></table></figure>
<h4 id="videoFormatDescription"><a href="#videoFormatDescription" class="headerlink" title="videoFormatDescription"></a>videoFormatDescription</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*! </span></span><br><span class="line"><span class="comment">	@functiongroup	Video-specific functions</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@typedef CMVideoFormatDescriptionRef</span></span><br><span class="line"><span class="comment">	Synonym type used for manipulating video CMFormatDescriptions</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">CMVideoFormatDescription</span> = <span class="type">CMFormatDescription</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>A reference to a CMFormatDescription, a CF object describing media of a particular type (audio, video, muxed, etc).</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*! @param allocator</span></span><br><span class="line"><span class="comment">																		CFAllocator to be used when creating the CMFormatDescription. NULL will cause the default allocator to be used */</span></span><br><span class="line"><span class="comment">/*! @param imageBuffer</span></span><br><span class="line"><span class="comment">																		Image buffer for which we are creating the format description. */</span></span><br><span class="line"><span class="comment">/*! @param outDesc</span></span><br><span class="line"><span class="comment">																		Returned newly-created video CMFormatDescription */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	CMVideoFormatDescriptionCreateFromH264ParameterSets</span></span><br><span class="line"><span class="comment">	@abstract	Creates a format description for a video media stream described by H.264 parameter set NAL units.</span></span><br><span class="line"><span class="comment">	@discussion	This function parses the dimensions provided by the parameter sets and creates a format description suitable for a raw H.264 stream.</span></span><br><span class="line"><span class="comment">				The parameter sets' data can come from raw NAL units and must have any emulation prevention bytes needed.</span></span><br><span class="line"><span class="comment">				The supported NAL unit types to be included in the format description are 7 (sequence parameter set), 8 (picture parameter set) and 13 (sequence parameter set extension). At least one sequence parameter set and one picture parameter set must be provided.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> videoFormatDescription: <span class="type">CMVideoFormatDescription</span>?</span><br><span class="line"><span class="type">CMVideoFormatDescriptionCreateFromH264ParameterSets</span>(<span class="literal">nil</span>, <span class="number">2</span>, [sps, pps], [spsSize, ppsSize], <span class="number">4</span>, &amp;videoFormatDescription)</span><br></pre></td></tr></table></figure>
<h4 id="destinationImageBufferAttributes"><a href="#destinationImageBufferAttributes" class="headerlink" title="destinationImageBufferAttributes"></a>destinationImageBufferAttributes</h4><p><img src="/images/2018-01-18-VideoToolbox/17.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> destinationImageBufferAttributes: <span class="type">CFDictionary</span> = [kCVPixelBufferOpenGLESCompatibilityKey: kCFBooleanTrue] <span class="keyword">as</span> <span class="type">CFDictionary</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-01-18-VideoToolbox/18.png" alt=""></p>
<blockquote>
<p>在输出的过程中，不要将YUV转换成BGRA的格式，否则将会在内存中有两份Buffer，降低性能。</p>
</blockquote>
<h4 id="outputCallback"><a href="#outputCallback" class="headerlink" title="outputCallback"></a>outputCallback</h4><p>解码回调回返回<code>CVPixelBuffer</code>，时间戳，解码错误码，丢弃帧。</p>
<p><img src="/images/2018-01-18-VideoToolbox/19.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> record = <span class="type">VTDecompressionOutputCallbackRecord</span>(decompressionOutputCallback: &#123; (decompressionOutputRefCon, sourceFrameRefCon, status, infoFlags, imageBuffer, presentationTimeStamp, presentationDuration) <span class="keyword">in</span></span><br><span class="line"><span class="comment">/// imageBuffer has been decompressed.</span></span><br><span class="line">&#125;, decompressionOutputRefCon: selfInstance)</span><br></pre></td></tr></table></figure>
<h3 id="VTDecompressionSessionDecodeFrame"><a href="#VTDecompressionSessionDecodeFrame" class="headerlink" title="VTDecompressionSessionDecodeFrame"></a>VTDecompressionSessionDecodeFrame</h3><p><img src="/images/2018-01-18-VideoToolbox/20.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">decode</span><span class="params">(frame: CMSampleBuffer)</span></span> &#123;</span><br><span class="line">    <span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTDecompressionSessionDecodeFrame</span></span><br><span class="line"><span class="comment">	@abstract	Decompresses a video frame.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		If an error is returned from this function, there will be no callback.  Otherwise</span></span><br><span class="line"><span class="comment">		the callback provided during VTDecompressionSessionCreate will be called.</span></span><br><span class="line"><span class="comment">	@param	session</span></span><br><span class="line"><span class="comment">		The decompression session.</span></span><br><span class="line"><span class="comment">	@param	sampleBuffer</span></span><br><span class="line"><span class="comment">		A CMSampleBuffer containing one or more video frames.  </span></span><br><span class="line"><span class="comment">	@param	decodeFlags</span></span><br><span class="line"><span class="comment">		A bitfield of directives to the decompression session and decoder.</span></span><br><span class="line"><span class="comment">		The kVTDecodeFrame_EnableAsynchronousDecompression bit indicates whether the video decoder </span></span><br><span class="line"><span class="comment">		may decompress the frame asynchronously.</span></span><br><span class="line"><span class="comment">		The kVTDecodeFrame_EnableTemporalProcessing bit indicates whether the decoder may delay calls to the output callback</span></span><br><span class="line"><span class="comment">		so as to enable processing in temporal (display) order.</span></span><br><span class="line"><span class="comment">		If both flags are clear, the decompression shall complete and your output callback function will be called </span></span><br><span class="line"><span class="comment">		before VTDecompressionSessionDecodeFrame returns.</span></span><br><span class="line"><span class="comment">		If either flag is set, VTDecompressionSessionDecodeFrame may return before the output callback function is called.  </span></span><br><span class="line"><span class="comment">	@param	sourceFrameRefCon</span></span><br><span class="line"><span class="comment">		Your reference value for the frame.  </span></span><br><span class="line"><span class="comment">		Note that if sampleBuffer contains multiple frames, the output callback function will be called</span></span><br><span class="line"><span class="comment">		multiple times with this sourceFrameRefCon.</span></span><br><span class="line"><span class="comment">	@param	infoFlagsOut</span></span><br><span class="line"><span class="comment">		Points to a VTDecodeInfoFlags to receive information about the decode operation.</span></span><br><span class="line"><span class="comment">		The kVTDecodeInfo_Asynchronous bit may be set if the decode is (or was) running</span></span><br><span class="line"><span class="comment">		asynchronously.</span></span><br><span class="line"><span class="comment">		The kVTDecodeInfo_FrameDropped bit may be set if the frame was dropped (synchronously).</span></span><br><span class="line"><span class="comment">		Pass NULL if you do not want to receive this information.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">/// 默认是同步操作</span></span><br><span class="line">    <span class="type">VTDecompressionSessionDecodeFrame</span>(deCompressSession!, frame, [], selfInstance, <span class="literal">nil</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 如果是iOS9以上，推荐用这个方法。</span></span><br><span class="line">    <span class="keyword">if</span> #available(iOS <span class="number">9.0</span>, *) &#123;</span><br><span class="line">        <span class="type">VTDecompressionSessionDecodeFrameWithOutputHandler</span>(deCompressSession!, frame, [], <span class="literal">nil</span>) &#123; (status, infoFlags, imageBuffer, presentationTimeStamp, presentationDuration) <span class="keyword">in</span></span><br><span class="line">                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Fallback on earlier versions</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Asynchronously-Decompress"><a href="#Asynchronously-Decompress" class="headerlink" title="Asynchronously Decompress"></a>Asynchronously Decompress</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTDecompressionSessionDecodeFrame</span></span><br><span class="line"><span class="comment">	@abstract	Decompresses a video frame.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		If an error is returned from this function, there will be no callback.  Otherwise</span></span><br><span class="line"><span class="comment">		the callback provided during VTDecompressionSessionCreate will be called.</span></span><br><span class="line"><span class="comment">	@param	session</span></span><br><span class="line"><span class="comment">		The decompression session.</span></span><br><span class="line"><span class="comment">	@param	sampleBuffer</span></span><br><span class="line"><span class="comment">		A CMSampleBuffer containing one or more video frames.  </span></span><br><span class="line"><span class="comment">	@param	decodeFlags</span></span><br><span class="line"><span class="comment">		A bitfield of directives to the decompression session and decoder.</span></span><br><span class="line"><span class="comment">		The kVTDecodeFrame_EnableAsynchronousDecompression bit indicates whether the video decoder </span></span><br><span class="line"><span class="comment">		may decompress the frame asynchronously.</span></span><br><span class="line"><span class="comment">		The kVTDecodeFrame_EnableTemporalProcessing bit indicates whether the decoder may delay calls to the output callback</span></span><br><span class="line"><span class="comment">		so as to enable processing in temporal (display) order.</span></span><br><span class="line"><span class="comment">		If both flags are clear, the decompression shall complete and your output callback function will be called </span></span><br><span class="line"><span class="comment">		before VTDecompressionSessionDecodeFrame returns.</span></span><br><span class="line"><span class="comment">		If either flag is set, VTDecompressionSessionDecodeFrame may return before the output callback function is called.  </span></span><br><span class="line"><span class="comment">	@param	sourceFrameRefCon</span></span><br><span class="line"><span class="comment">		Your reference value for the frame.  </span></span><br><span class="line"><span class="comment">		Note that if sampleBuffer contains multiple frames, the output callback function will be called</span></span><br><span class="line"><span class="comment">		multiple times with this sourceFrameRefCon.</span></span><br><span class="line"><span class="comment">	@param	infoFlagsOut</span></span><br><span class="line"><span class="comment">		Points to a VTDecodeInfoFlags to receive information about the decode operation.</span></span><br><span class="line"><span class="comment">		The kVTDecodeInfo_Asynchronous bit may be set if the decode is (or was) running</span></span><br><span class="line"><span class="comment">		asynchronously.</span></span><br><span class="line"><span class="comment">		The kVTDecodeInfo_FrameDropped bit may be set if the frame was dropped (synchronously).</span></span><br><span class="line"><span class="comment">		Pass NULL if you do not want to receive this information.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 异步需要设置flag为kVTDecodeFrame_EnableAsynchronousDecompression</span></span><br><span class="line"><span class="type">VTDecompressionSessionDecodeFrame</span>(deCompressSession!, frame, [._EnableAsynchronousDecompression], selfInstance, <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>在异步回调的时候会出现内部解码管道已经满了，这个时候当前解码会block住，直到有空闲的空间继续进行解码。</li>
<li>使用<code>VTDecompressionSessionWaitForAsynchronousFrames</code>会等到所有的解码完成再返回。</li>
</ol>
<h3 id="VTDecompressionSessionCanAcceptFormatDescription"><a href="#VTDecompressionSessionCanAcceptFormatDescription" class="headerlink" title="VTDecompressionSessionCanAcceptFormatDescription"></a>VTDecompressionSessionCanAcceptFormatDescription</h3><p>在解码的过程中如果遇到I帧，则需要更换sps和pps，这个时候可以用<code>VTDecompressionSessionCanAcceptFormatDescription</code>来判断是否能够在不创建新的session情况下继续进行解码，否则就需要创建新的session。</p>
<p><img src="/images/2018-01-18-VideoToolbox/21.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function VTDecompressionSessionCanAcceptFormatDescription</span></span><br><span class="line"><span class="comment">	@abstract Indicates whether the session can decode frames with the given format description.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		Some video decoders are able to accommodate minor changes in format without needing to be</span></span><br><span class="line"><span class="comment">		completely reset in a new session.  This function can be used to test whether a format change</span></span><br><span class="line"><span class="comment">		is sufficiently minor.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> <span class="type">VTDecompressionSessionCanAcceptFormatDescription</span>(deCompressSession!, videoFormatDescription!) &#123;</span><br><span class="line">    <span class="comment">/// Continue decompress.</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/// Need to create new session.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用<code>VTDecompressionSessionInvalidate</code>销毁旧的session。</p>
</blockquote>
<h3 id="Decompress-Summary"><a href="#Decompress-Summary" class="headerlink" title="Decompress Summary"></a>Decompress Summary</h3><ol>
<li>当解码的过程中遇到I帧的时候，需要判断新的sps和pps组成的<code>CMVideoFormatDescription</code>是否能够在不创建新的session情况下继续解码，否则需要重新创建session。这样做保证了在传输过程中如果一段数据出错则不会继续扩大影响。</li>
</ol>
<hr>
<h2 id="Compress"><a href="#Compress" class="headerlink" title="Compress"></a>Compress</h2><p><img src="/images/2018-01-18-VideoToolbox/23.png" alt=""></p>
<p>编码流程：</p>
<ol>
<li>使用<code>VTCompressionSessionCreate(_:_:_:_:_:_:_:_:_:_:)</code>创建编码会话</li>
<li>使用<code>VTSessionSetProperty(_:_:_:)</code>或者<code>VTSessionSetProperties(_:_:)</code>设置会话参数</li>
<li>使用<code>VTCompressionSessionEncodeFrame(_:_:_:_:_:_:_:)</code>编码视频帧，在<code>VTCompressionOutputCallback</code>得到编码后的结果。</li>
<li>使用<code>VTCompressionSessionCompleteFrames(_:_:)</code>来强制结束并完成编码。</li>
<li>编码完成之后使用<code>VTCompressionSessionInvalidate(_:)</code>结束编码，并释放内存。</li>
</ol>
<blockquote>
<p>编码通俗的来说就是将多个无相关的帧编码成有相关性帧的一个过程。从摄像头输出的每个<code>CMSampleBuffer</code>之间都没有关联，都是原始图像数据。而编码就是将连续帧相似的地方提取出来，然后压缩，去掉无用像素等，使得这些连续的帧关联在一起的过程。</p>
</blockquote>
<h3 id="VTCompressionSession"><a href="#VTCompressionSession" class="headerlink" title="VTCompressionSession"></a>VTCompressionSession</h3><p>创建编码会话，指定编码器的类型为H.264(<code>kCMVideoCodecType_H264</code>)。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTCompressionSessionCreate</span></span><br><span class="line"><span class="comment">	@abstract	Creates a session for compressing video frames.</span></span><br><span class="line"><span class="comment">    @discussion </span></span><br><span class="line"><span class="comment">		Compressed frames will be emitted through calls to outputCallback.</span></span><br><span class="line"><span class="comment">	@param	allocator</span></span><br><span class="line"><span class="comment">		An allocator for the session.  Pass NULL to use the default allocator.</span></span><br><span class="line"><span class="comment">	@param	width</span></span><br><span class="line"><span class="comment">		The width of frames, in pixels.  </span></span><br><span class="line"><span class="comment">		If the video encoder cannot support the provided width and height it may change them.</span></span><br><span class="line"><span class="comment">	@param	height</span></span><br><span class="line"><span class="comment">		The height of frames in pixels.</span></span><br><span class="line"><span class="comment">	@param	cType</span></span><br><span class="line"><span class="comment">		The codec type.</span></span><br><span class="line"><span class="comment">	@param	encoderSpecification</span></span><br><span class="line"><span class="comment">		Specifies a particular video encoder that must be used.  </span></span><br><span class="line"><span class="comment">		Pass NULL to let the video toolbox choose a encoder.</span></span><br><span class="line"><span class="comment">	@param	sourceImageBufferAttributes</span></span><br><span class="line"><span class="comment">		Required attributes for source pixel buffers, used when creating a pixel buffer pool </span></span><br><span class="line"><span class="comment">		for source frames.  If you do not want the Video Toolbox to create one for you, pass NULL.</span></span><br><span class="line"><span class="comment">		(Using pixel buffers not allocated by the Video Toolbox may increase the chance that</span></span><br><span class="line"><span class="comment">		it will be necessary to copy image data.)</span></span><br><span class="line"><span class="comment">	@param	compressedDataAllocator</span></span><br><span class="line"><span class="comment">		An allocator for the compressed data.  Pass NULL to use the default allocator.</span></span><br><span class="line"><span class="comment"> 		Note: on MacOS 10.12 and later, using a compressedDataAllocator may trigger an extra buffer copy.</span></span><br><span class="line"><span class="comment">	@param	outputCallback</span></span><br><span class="line"><span class="comment">		The callback to be called with compressed frames.</span></span><br><span class="line"><span class="comment">		This function may be called asynchronously, on a different thread from the one that calls VTCompressionSessionEncodeFrame.</span></span><br><span class="line"><span class="comment">		Pass NULL if and only if you will be calling VTCompressionSessionEncodeFrameWithOutputHandler for encoding frames.</span></span><br><span class="line"><span class="comment">	@param	outputCallbackRefCon</span></span><br><span class="line"><span class="comment">		Client-defined reference value for the output callback.</span></span><br><span class="line"><span class="comment">	@param	compressionSessionOut</span></span><br><span class="line"><span class="comment">		Points to a variable to receive the new compression session.</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">status = <span class="type">VTCompressionSessionCreate</span>(<span class="literal">nil</span>, width, height, kCMVideoCodecType_H264, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, &#123; (outputCallbackRefCon, sourceFrameRefCon, status, infoFlags, sampleBuffer) <span class="keyword">in</span></span><br><span class="line"><span class="comment">/// sampleBuffer has been compressed.      </span></span><br><span class="line">&#125;, selfInstance, &amp;compressionSession)</span><br></pre></td></tr></table></figure>
<h3 id="VTSessionSetProperty"><a href="#VTSessionSetProperty" class="headerlink" title="VTSessionSetProperty"></a>VTSessionSetProperty</h3><p>Sets a property on a VideoToolbox session.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_RealTime</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Hints the video encoder that compression is, or is not, being performed in real time.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		For offline compression, clients may set this property to kCFBooleanFalse, which indicates that </span></span><br><span class="line"><span class="comment">		it is OK for the video encoder to work slower than real time in order to produce a better result.</span></span><br><span class="line"><span class="comment">		For real-time compression, clients may set this property to kCFBooleanTrue to recommend that encoding stay timely.</span></span><br><span class="line"><span class="comment">		By default, this property is NULL, indicating unknown.  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 是否实时编码，默认是未知。在直播过程中肯定需要实时编码。</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_RealTime, kCFBooleanTrue)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_ProfileLevel</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Specifies the profile and level for the encoded bitstream.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		Available profiles and levels vary across formats and between video encoders.</span></span><br><span class="line"><span class="comment">		Video encoders should use standard keys where available, and follow standard patterns where not.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 对于编码流指定配置和标准，Baseline、Main、Extended、High，级别越高，压缩的效果越好，但算法复杂度更高，导致功耗也更高。</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_ProfileLevel, kVTProfileLevel_H264_Baseline_AutoLevel)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_MaxKeyFrameInterval</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		The maximum interval between key frames, also known as the key frame rate. </span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		Key frames, also known as sync frames, reset inter-frame</span></span><br><span class="line"><span class="comment">		dependencies; decoding a key frame is sufficient to prepare a</span></span><br><span class="line"><span class="comment">		decoder for correctly decoding the difference frames that</span></span><br><span class="line"><span class="comment">		follow. </span></span><br><span class="line"><span class="comment">		Video encoders are allowed to generate key frames more frequently if</span></span><br><span class="line"><span class="comment">		this would result in more efficient compression. </span></span><br><span class="line"><span class="comment">		The default key frame interval is 0, which indicates that the</span></span><br><span class="line"><span class="comment">		video encoder should choose where to place all key frames. A key</span></span><br><span class="line"><span class="comment">		frame interval of 1 indicates that every frame must be a key</span></span><br><span class="line"><span class="comment">		frame, 2 indicates that at least every other frame must be a key</span></span><br><span class="line"><span class="comment">		frame, etc.</span></span><br><span class="line"><span class="comment">		See also kVTCompressionPropertyKey_AllowTemporalCompression.</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">		This key can be set in conjunction with </span></span><br><span class="line"><span class="comment">		kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration,</span></span><br><span class="line"><span class="comment">		and both limits will be enforced - requiring a keyframe every X</span></span><br><span class="line"><span class="comment">		frames or every Y seconds, whichever comes first.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 最大帧间隔，也就是两个I帧之间的距离，参考WebRTC。</span></span><br><span class="line"><span class="keyword">var</span> maxKeyFrameInterval = <span class="number">7200</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_MaxKeyFrameInterval, <span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .intType, &amp;maxKeyFrameInterval))</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		The maximum duration from one key frame to the next in seconds. </span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		Zero by default, which means no limit.  </span></span><br><span class="line"><span class="comment">		This property is particularly useful when the frame rate is variable.</span></span><br><span class="line"><span class="comment">		See kVTCompressionPropertyKey_MaxKeyFrameInterval for more discussion</span></span><br><span class="line"><span class="comment">		of key frames.</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">		This key can be set in conjunction with </span></span><br><span class="line"><span class="comment">		kVTCompressionPropertyKey_MaxKeyFrameInterval,</span></span><br><span class="line"><span class="comment">		and both limits will be enforced - requiring a keyframe every X</span></span><br><span class="line"><span class="comment">		frames or every Y seconds, whichever comes first.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 最大帧间隔持续时间，参考WebRTC。</span></span><br><span class="line"><span class="keyword">var</span> maxKeyFrameIntervalDuration = <span class="number">240</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration, <span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .doubleType, &amp;maxKeyFrameIntervalDuration))</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_AllowFrameReordering</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Enables frame reordering. </span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		In order to encode B frames, a video encoder must reorder frames,</span></span><br><span class="line"><span class="comment">		which means that the order in which they will be emitted and</span></span><br><span class="line"><span class="comment">		stored (the decode order) is different from the order in which</span></span><br><span class="line"><span class="comment">		they were presented to the video encoder (the display order). </span></span><br><span class="line"><span class="comment">		True by default.  Set this to false to prevent frame reordering.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 是否启用帧记录，默认开启，参考WebRTC。</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_AllowFrameReordering, kCFBooleanFalse)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_AverageBitRate</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		The long-term desired average bit rate in bits per second. </span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		This is not a hard limit; the bit rate may peak above this. </span></span><br><span class="line"><span class="comment">		The default bit rate is zero, which indicates that the video encoder </span></span><br><span class="line"><span class="comment">		should determine the size of compressed data. </span></span><br><span class="line"><span class="comment">		Note that bit rate settings only have an effect when timing</span></span><br><span class="line"><span class="comment">		information is provided for source frames, and that some codecs do</span></span><br><span class="line"><span class="comment">		not support limiting to specified bit rates.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 平均码率，可选设置，单位是bps，参考最佳设置</span></span><br><span class="line"><span class="comment">/// ⚠️ 该参数仅在CBR编码下有效，有些编码器不支持设置这个参数。</span></span><br><span class="line"><span class="keyword">var</span> averageBitRate: <span class="type">Int32</span> = <span class="number">1216</span> * <span class="number">1024</span> * <span class="number">8</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_AverageBitRate, <span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .sInt32Type, &amp;averageBitRate))</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_ExpectedFrameRate</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Indicates the expected frame rate, if known.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		The frame rate is measured in frames per second. </span></span><br><span class="line"><span class="comment">		This is not used to control the frame rate; it is provided as a hint to the </span></span><br><span class="line"><span class="comment">		video encoder so that it can set up internal configuration before compression begins. </span></span><br><span class="line"><span class="comment">		The actual frame rate will depend on frame durations and may vary. </span></span><br><span class="line"><span class="comment">		By default, this is zero, indicating "unknown".</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 设置期望帧率，默认是0。</span></span><br><span class="line"><span class="comment">// ⚠️ 这个不是用来控制帧率的，它仅仅是让编码器在编码之前设置内部配置的，帧速率依赖于帧持续时间的平均值。 </span></span><br><span class="line"><span class="keyword">var</span> fps = <span class="number">24</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_ExpectedFrameRate, <span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .intType, &amp;fps))</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kVTCompressionPropertyKey_DataRateLimits</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Zero, one or two hard limits on data rate.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		Each hard limit is described by a data size in bytes and a</span></span><br><span class="line"><span class="comment">		duration in seconds, and requires that the total size of</span></span><br><span class="line"><span class="comment">		compressed data for any contiguous segment of that duration (in</span></span><br><span class="line"><span class="comment">		decode time) must not exceed the data size. </span></span><br><span class="line"><span class="comment">		By default, no data rate limits are set. </span></span><br><span class="line"><span class="comment">		The property is a CFArray of an even number of CFNumbers,</span></span><br><span class="line"><span class="comment">		alternating between bytes and seconds.</span></span><br><span class="line"><span class="comment">		Note that data rate settings only have an effect when timing</span></span><br><span class="line"><span class="comment">		information is provided for source frames, and that some codecs do</span></span><br><span class="line"><span class="comment">		not support limiting to specified data rates.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 码率限制，[bytes, seconds, bytes, seconds...]，参考WebRTC，一般设置为码率的1.5倍。</span></span><br><span class="line"><span class="keyword">var</span> oneSecond: <span class="type">Int32</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> bytesPerSecond: <span class="type">Int32</span> = averageBitRate * <span class="number">3</span> / <span class="number">2</span> / <span class="number">8</span></span><br><span class="line"><span class="keyword">let</span> limitArray = [<span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .sInt32Type, &amp;oneSecond), <span class="type">CFNumberCreate</span>(kCFAllocatorDefault, .sInt32Type, &amp;bytesPerSecond)] <span class="keyword">as</span> <span class="type">CFArray</span></span><br><span class="line"><span class="type">VTSessionSetProperty</span>(compressionSession!, kVTCompressionPropertyKey_DataRateLimits, limitArray)</span><br></pre></td></tr></table></figure>
<h4 id="WebRTC"><a href="#WebRTC" class="headerlink" title="WebRTC"></a>WebRTC</h4><p>下面是WebRTC的配置代码。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)configureCompressionSession &#123;</span><br><span class="line">  RTC_DCHECK(_compressionSession);</span><br><span class="line">  SetVTSessionProperty(_compressionSession, kVTCompressionPropertyKey_RealTime, <span class="literal">true</span>);</span><br><span class="line">  SetVTSessionProperty(_compressionSession, kVTCompressionPropertyKey_ProfileLevel, _profile);</span><br><span class="line">  SetVTSessionProperty(_compressionSession, kVTCompressionPropertyKey_AllowFrameReordering, <span class="literal">false</span>);</span><br><span class="line">  [<span class="keyword">self</span> setEncoderBitrateBps:_targetBitrateBps];</span><br><span class="line">  <span class="comment">// TODO(tkchin): Look at entropy mode and colorspace matrices.</span></span><br><span class="line">  <span class="comment">// TODO(tkchin): Investigate to see if there's any way to make this work.</span></span><br><span class="line">  <span class="comment">// May need it to interop with Android. Currently this call just fails.</span></span><br><span class="line">  <span class="comment">// On inspecting encoder output on iOS8, this value is set to 6.</span></span><br><span class="line">  <span class="comment">// internal::SetVTSessionProperty(compression_session_,</span></span><br><span class="line">  <span class="comment">//     kVTCompressionPropertyKey_MaxFrameDelayCount,</span></span><br><span class="line">  <span class="comment">//     1);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set a relatively large value for keyframe emission (7200 frames or 4 minutes).</span></span><br><span class="line">  SetVTSessionProperty(_compressionSession, kVTCompressionPropertyKey_MaxKeyFrameInterval, <span class="number">7200</span>);</span><br><span class="line">  SetVTSessionProperty(</span><br><span class="line">      _compressionSession, kVTCompressionPropertyKey_MaxKeyFrameIntervalDuration, <span class="number">240</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setEncoderBitrateBps:(uint32_t)bitrateBps &#123;</span><br><span class="line">  <span class="keyword">if</span> (_compressionSession) &#123;</span><br><span class="line">    SetVTSessionProperty(_compressionSession, kVTCompressionPropertyKey_AverageBitRate, bitrateBps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(tkchin): Add a helper method to set array value.</span></span><br><span class="line">    int64_t dataLimitBytesPerSecondValue =</span><br><span class="line">        static_cast&lt;int64_t&gt;(bitrateBps * kLimitToAverageBitRateFactor / <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">CFNumberRef</span> bytesPerSecond =</span><br><span class="line">        <span class="built_in">CFNumberCreate</span>(kCFAllocatorDefault, kCFNumberSInt64Type, &amp;dataLimitBytesPerSecondValue);</span><br><span class="line">    int64_t oneSecondValue = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">CFNumberRef</span> oneSecond =</span><br><span class="line">        <span class="built_in">CFNumberCreate</span>(kCFAllocatorDefault, kCFNumberSInt64Type, &amp;oneSecondValue);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *nums[<span class="number">2</span>] = &#123;bytesPerSecond, oneSecond&#125;;</span><br><span class="line">    <span class="built_in">CFArrayRef</span> dataRateLimits = <span class="built_in">CFArrayCreate</span>(nullptr, nums, <span class="number">2</span>, &amp;kCFTypeArrayCallBacks);</span><br><span class="line">    OSStatus status = VTSessionSetProperty(</span><br><span class="line">        _compressionSession, kVTCompressionPropertyKey_DataRateLimits, dataRateLimits);</span><br><span class="line">    <span class="keyword">if</span> (bytesPerSecond) &#123;</span><br><span class="line">      <span class="built_in">CFRelease</span>(bytesPerSecond);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oneSecond) &#123;</span><br><span class="line">      <span class="built_in">CFRelease</span>(oneSecond);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dataRateLimits) &#123;</span><br><span class="line">      <span class="built_in">CFRelease</span>(dataRateLimits);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status != noErr) &#123;</span><br><span class="line">      LOG(LS_ERROR) &lt;&lt; <span class="string">"Failed to set data rate limit"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _encoderBitrateBps = bitrateBps;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>详细内容请看：<a href="https://chromium.googlesource.com/external/webrtc/+/master/sdk/objc/Framework/Classes/VideoToolbox/RTCVideoEncoderH264.mm" target="_blank" rel="noopener">WebRTC-RTCVideoEncoderH264</a></p>
</blockquote>
<h3 id="VTCompressionSessionPrepareToEncodeFrames"><a href="#VTCompressionSessionPrepareToEncodeFrames" class="headerlink" title="VTCompressionSessionPrepareToEncodeFrames"></a>VTCompressionSessionPrepareToEncodeFrames</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTCompressionSessionPrepareToEncodeFrames</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		You can optionally call this function to provide the encoder with an opportunity to perform</span></span><br><span class="line"><span class="comment">		any necessary resource allocation before it begins encoding frames.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		This optional call can be used to provide the encoder an opportunity to allocate</span></span><br><span class="line"><span class="comment">		any resources necessary before it begins encoding frames.  If this isn't called, any</span></span><br><span class="line"><span class="comment">		necessary resources will be allocated on the first VTCompressionSessionEncodeFrame call.</span></span><br><span class="line"><span class="comment">		Extra calls to this function will have no effect.</span></span><br><span class="line"><span class="comment">	@param	session</span></span><br><span class="line"><span class="comment">		The compression session.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">VTCompressionSessionPrepareToEncodeFrames</span>(compressionSession!)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>调用的目的就是告诉编码器分配相应的内存空间。可以不用调用，编码器会在第一次调用<code>VTCompressionSessionEncodeFrame</code>的时候再分配。</p>
</blockquote>
<h3 id="VTCompressionSessionEncodeFrame"><a href="#VTCompressionSessionEncodeFrame" class="headerlink" title="VTCompressionSessionEncodeFrame"></a>VTCompressionSessionEncodeFrame</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@function	VTCompressionSessionEncodeFrame</span></span><br><span class="line"><span class="comment">	@abstract</span></span><br><span class="line"><span class="comment">		Call this function to present frames to the compression session.</span></span><br><span class="line"><span class="comment">		Encoded frames may or may not be output before the function returns.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		The client should not modify the pixel data after making this call.</span></span><br><span class="line"><span class="comment">		The session and/or encoder will retain the image buffer as long as necessary. </span></span><br><span class="line"><span class="comment">	@param	session</span></span><br><span class="line"><span class="comment">		The compression session.</span></span><br><span class="line"><span class="comment">	@param	imageBuffer</span></span><br><span class="line"><span class="comment">		A CVImageBuffer containing a video frame to be compressed.  </span></span><br><span class="line"><span class="comment">		Must have a nonzero reference count.</span></span><br><span class="line"><span class="comment">	@param	presentationTimeStamp</span></span><br><span class="line"><span class="comment">		The presentation timestamp for this frame, to be attached to the sample buffer.</span></span><br><span class="line"><span class="comment">		Each presentation timestamp passed to a session must be greater than the previous one.</span></span><br><span class="line"><span class="comment">	@param	duration</span></span><br><span class="line"><span class="comment">		The presentation duration for this frame, to be attached to the sample buffer.  </span></span><br><span class="line"><span class="comment">		If you do not have duration information, pass kCMTimeInvalid.</span></span><br><span class="line"><span class="comment">	@param	frameProperties</span></span><br><span class="line"><span class="comment">		Contains key/value pairs specifying additional properties for encoding this frame.</span></span><br><span class="line"><span class="comment">		Note that some session properties may also be changed between frames.</span></span><br><span class="line"><span class="comment">		Such changes have effect on subsequently encoded frames.</span></span><br><span class="line"><span class="comment">	@param	sourceFrameRefCon</span></span><br><span class="line"><span class="comment">		Your reference value for the frame, which will be passed to the output callback function.</span></span><br><span class="line"><span class="comment">	@param	infoFlagsOut</span></span><br><span class="line"><span class="comment">		Points to a VTEncodeInfoFlags to receive information about the encode operation.</span></span><br><span class="line"><span class="comment">		The kVTEncodeInfo_Asynchronous bit may be set if the encode is (or was) running</span></span><br><span class="line"><span class="comment">		asynchronously.</span></span><br><span class="line"><span class="comment">		The kVTEncodeInfo_FrameDropped bit may be set if the frame was dropped (synchronously).</span></span><br><span class="line"><span class="comment">		Pass NULL if you do not want to receive this information.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/// 编码，从文档上来看，可能是同步，也可能是异步。</span></span><br><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">encode</span><span class="params">(frame: CMSampleBuffer)</span></span> &#123;</span><br><span class="line">    <span class="type">VTCompressionSessionEncodeFrame</span>(compressionSession!, <span class="type">CMSampleBufferGetImageBuffer</span>(frame)!, <span class="type">CMSampleBufferGetPresentationTimeStamp</span>(frame), kCMTimeInvalid, <span class="literal">nil</span>, selfInstance, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// iOS9以上推荐使用这个方法。</span></span><br><span class="line">    <span class="keyword">if</span> #available(iOS <span class="number">9.0</span>, *) &#123;</span><br><span class="line">        <span class="type">VTCompressionSessionEncodeFrameWithOutputHandler</span>(compressionSession!, <span class="type">CMSampleBufferGetImageBuffer</span>(frame)!, <span class="type">CMSampleBufferGetPresentationTimeStamp</span>(frame), kCMTimeInvalid, <span class="literal">nil</span>, <span class="literal">nil</span>) &#123; (status, infoFlags, sampleBuffer) <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Fallback on earlier versions</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Compress-Summary"><a href="#Compress-Summary" class="headerlink" title="Compress Summary"></a>Compress Summary</h3><p>很多人不知道如何设置的码率，最大帧间隔等这个参数，参照下面的设置就可以。</p>
<p><img src="/images/2018-01-18-VideoToolbox/14.png" alt=""></p>
<p><img src="/images/2018-01-18-VideoToolbox/15.png" alt=""></p>
<blockquote>
<p>更多详细的内容：<a href="http://www.lighterra.com/papers/videoencodingh264/" target="_blank" rel="noopener">Video Encoding Settings for H.264 Excellence</a></p>
</blockquote>
<hr>
<h1 id="Advances"><a href="#Advances" class="headerlink" title="Advances"></a>Advances</h1><h2 id="Decompress-amp-amp-Compress-1"><a href="#Decompress-amp-amp-Compress-1" class="headerlink" title="Decompress &amp;&amp; Compress"></a>Decompress &amp;&amp; Compress</h2><h3 id="Decompress-H-264-Elementary-Stream-Flow"><a href="#Decompress-H-264-Elementary-Stream-Flow" class="headerlink" title="Decompress H.264 Elementary Stream Flow"></a>Decompress H.264 Elementary Stream Flow</h3><p>在这里将介绍如何将H.264码流解码。</p>
<h4 id="Stream-Datas-gt-CMSampleBuffer"><a href="#Stream-Datas-gt-CMSampleBuffer" class="headerlink" title="Stream Datas =&gt; CMSampleBuffer"></a>Stream Datas =&gt; CMSampleBuffer</h4><p>如何将数据流封装成CMSampleBuffer(CMBlockBuffer)</p>
<h5 id="Elementary-Stream-gt-MPEG-4"><a href="#Elementary-Stream-gt-MPEG-4" class="headerlink" title="Elementary Stream =&gt; MPEG-4"></a>Elementary Stream =&gt; MPEG-4</h5><ol>
<li>使用<code>CMVideoFormatDescriptionCreateFromH264ParameterSets</code>来将SPS和PPS封装成<code>CMVideoFormatDescription</code></li>
</ol>
<p><img src="/images/2018-01-18-VideoToolbox/8.png" alt=""></p>
<blockquote>
<p><code>CMVideoFormatDescription</code><br>A synonym type used for manipulating video CMFormatDescriptions.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typealias</span> <span class="type">CMVideoFormatDescription</span> = <span class="type">CMFormatDescription</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li>修改NALU的Header</li>
</ol>
<p><img src="/images/2018-01-18-VideoToolbox/9.png" alt=""></p>
<blockquote>
<p>NALU它主要有两种格式：Annex B 和 AVCC。也被称为 Elementary Stream 和 MPEG-4 格式，Annex B格式以 0x000001 或 0x00000001 开头，AVCC 格式以所在的 NALU 的长度开头。</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/10.png" alt=""></p>
<blockquote>
<p>首先我们需要将Header的Start Code替换，然后将NAL Unit封装成<code>CMBlockBuffer</code>，在这里可能Frame包含很多个NAL Unit，都需要包含进去。创建的方式我们使用<code>CMBlockBufferCreateWithMemoryBlock</code>。</p>
</blockquote>
<p><img src="/images/2018-01-18-VideoToolbox/11.png" alt=""></p>
<blockquote>
<p>最后<code>CMBlockBuffer</code>+<code>CMVideoFormatDesc</code>+<code>CMTime</code>通过<code>CMSampleBufferCreate</code>生成<code>CMSampleBuffer</code>。</p>
<p>也可以用<code>CMSampleBufferCreateReady</code>生成已经Ready<code>CMSampleBuffer</code>。</p>
</blockquote>
<h3 id="Compress-1"><a href="#Compress-1" class="headerlink" title="Compress"></a>Compress</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The following keys may be attached to individual samples via the CMSampleBufferGetSampleAttachmentsArray() interface:</span></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">4.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">let</span> kCMSampleAttachmentKey_NotSync: <span class="type">CFString</span> <span class="comment">// CFBoolean (absence of this key implies Sync)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">	@constant	kCMSampleBufferAttachmentKey_ForceKeyFrame</span></span><br><span class="line"><span class="comment">	@abstract	Indicates that the current or next video sample buffer should be forced to be encoded as a key frame.</span></span><br><span class="line"><span class="comment">	@discussion</span></span><br><span class="line"><span class="comment">		A value of kCFBooleanTrue for kCMSampleBufferAttachmentKey_ForceKeyFrame indicates that the current or next video sample buffer processed in the stream should be forced to be encoded as a key frame.</span></span><br><span class="line"><span class="comment">		If this attachment is present and kCFBooleanTrue on a sample buffer with a video frame, that video frame will be forced to become a key frame.  If the sample buffer for which this is present and kCFBooleanTrue does not have a valid video frame, the next sample buffer processed that contains a valid video frame will be encoded as a key frame.</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">		Usual care should be taken when setting attachments on sample buffers whose orgins and destinations are ambiguous.  For example, CMSetAttachment() is not thread-safe, and CMSampleBuffers may be used in multiple sample buffer streams in a given system.  This can lead to crashes during concurrent access and/or unexpected behavior on alternate sample buffer streams.  Therefore, unless the orgin and destination of a sample buffer is known, the general recommended practice is to synthesize an empty sample buffer with this attachment alone and insert it into the sample buffer stream ahead of the concrete sample buffer rather than setting this attachment on the concrete sample buffer itself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">let</span> kCMSampleBufferAttachmentKey_ForceKeyFrame: <span class="type">CFString</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h1><ol>
<li>个人觉得用Objective-C写这个部分比较好，让Swift直接和C函数进行交互着实很难受，可以先用Objective-C包装一层，再用Swift进行编写内容。</li>
<li>使用VideoToolbox其实并没有任何的难度，难的是各种概念的理解，参数该如何设置，为什么要这么设置，以及如何处理编码、解码后的数据。</li>
</ol>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><video width="100%" controls="controls" autoplay="autoplay"><br>  <source src="http://devstreaming.apple.com/videos/wwdc/2014/513xxhfudagscto/513/ref.mov"><br>  <source src="https://developer.apple.com/videos/images/ogg_bumper_no_tv.ogv" type="video/ogg"><br></video>

<p><a href="https://blog.qiniu.com/archives/6816" target="_blank" rel="noopener">《视频直播技术详解》之（四）：编码和封装</a></p>
<p><a href="https://tomisacat.xyz/tech/2017/08/21/iOS-hardware-accelerate-codec-with-videotoolbox.html" target="_blank" rel="noopener">初探 iOS 视频硬编解码</a></p>
<p><a href="http://img421.com/2016/08/05/si-shi-pin-de-bian-jie-ma-bian-ma-pian/" target="_blank" rel="noopener">四、视频的编解码-编码篇</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
            <a href="/tags/Swift-3-2-0/" rel="tag"># Swift 3.2.0</a>
          
            <a href="/tags/⭐️⭐️⭐️⭐️⭐️/" rel="tag"># ⭐️⭐️⭐️⭐️⭐️</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/10/Camera/" rel="next" title="Camera">
                <i class="fa fa-chevron-left"></i> Camera
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/22/Terminal/" rel="prev" title="Terminal">
                Terminal <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.png"
                alt="Mini灬哆啦" />
            
              <p class="site-author-name" itemprop="name">Mini灬哆啦</p>
              <p class="site-description motion-element" itemprop="description">It's only a matter of time</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/XWJACK/" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Common"><span class="nav-number">1.</span> <span class="nav-text">Common</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Swift中指针转换"><span class="nav-number">1.1.</span> <span class="nav-text">Swift中指针转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Technology"><span class="nav-number">1.2.</span> <span class="nav-text">Technology</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Video"><span class="nav-number">1.2.1.</span> <span class="nav-text">Core Video</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CVPixelBuffer"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">CVPixelBuffer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-Media"><span class="nav-number">1.2.2.</span> <span class="nav-text">Core Media</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CMBlockBuffer"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">CMBlockBuffer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMSampleBuffer"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">CMSampleBuffer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#H-264-amp-amp-H-265"><span class="nav-number">1.2.3.</span> <span class="nav-text">H.264 &amp;&amp; H.265</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#H-264"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">H.264</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#H-265"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">H.265</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Video-Formatter"><span class="nav-number">1.2.4.</span> <span class="nav-text">Video Formatter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FPS-Frames-PerSecond"><span class="nav-number">1.2.5.</span> <span class="nav-text">FPS(Frames PerSecond)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分辨率-Resolution"><span class="nav-number">1.2.6.</span> <span class="nav-text">分辨率(Resolution)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#比特率-Bit-Rate-码流-Data-Rate-码率"><span class="nav-number">1.2.7.</span> <span class="nav-text">比特率(Bit Rate)/码流(Data Rate)/码率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NALU"><span class="nav-number">1.2.8.</span> <span class="nav-text">NALU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I、B、P-Frames"><span class="nav-number">1.2.9.</span> <span class="nav-text">I、B、P Frames</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GOP-Group-Of-Picture"><span class="nav-number">1.2.10.</span> <span class="nav-text">GOP(Group Of Picture)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPS-amp-amp-PPS"><span class="nav-number">1.2.11.</span> <span class="nav-text">SPS &amp;&amp; PPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">1.2.12.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Decompress-amp-amp-Compress"><span class="nav-number">2.</span> <span class="nav-text">Decompress &amp;&amp; Compress</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Decompress"><span class="nav-number">2.1.</span> <span class="nav-text">Decompress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VTDecompressionSession"><span class="nav-number">2.1.1.</span> <span class="nav-text">VTDecompressionSession</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#videoFormatDescription"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">videoFormatDescription</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destinationImageBufferAttributes"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">destinationImageBufferAttributes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#outputCallback"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">outputCallback</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VTDecompressionSessionDecodeFrame"><span class="nav-number">2.1.2.</span> <span class="nav-text">VTDecompressionSessionDecodeFrame</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Asynchronously-Decompress"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">Asynchronously Decompress</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VTDecompressionSessionCanAcceptFormatDescription"><span class="nav-number">2.1.3.</span> <span class="nav-text">VTDecompressionSessionCanAcceptFormatDescription</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Decompress-Summary"><span class="nav-number">2.1.4.</span> <span class="nav-text">Decompress Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compress"><span class="nav-number">2.2.</span> <span class="nav-text">Compress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VTCompressionSession"><span class="nav-number">2.2.1.</span> <span class="nav-text">VTCompressionSession</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VTSessionSetProperty"><span class="nav-number">2.2.2.</span> <span class="nav-text">VTSessionSetProperty</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WebRTC"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">WebRTC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VTCompressionSessionPrepareToEncodeFrames"><span class="nav-number">2.2.3.</span> <span class="nav-text">VTCompressionSessionPrepareToEncodeFrames</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VTCompressionSessionEncodeFrame"><span class="nav-number">2.2.4.</span> <span class="nav-text">VTCompressionSessionEncodeFrame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compress-Summary"><span class="nav-number">2.2.5.</span> <span class="nav-text">Compress Summary</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Advances"><span class="nav-number">3.</span> <span class="nav-text">Advances</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Decompress-amp-amp-Compress-1"><span class="nav-number">3.1.</span> <span class="nav-text">Decompress &amp;&amp; Compress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Decompress-H-264-Elementary-Stream-Flow"><span class="nav-number">3.1.1.</span> <span class="nav-text">Decompress H.264 Elementary Stream Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Stream-Datas-gt-CMSampleBuffer"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">Stream Datas =&gt; CMSampleBuffer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Elementary-Stream-gt-MPEG-4"><span class="nav-number">3.1.1.1.1.</span> <span class="nav-text">Elementary Stream =&gt; MPEG-4</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compress-1"><span class="nav-number">3.1.2.</span> <span class="nav-text">Compress</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary-1"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mini灬哆啦</span>

  

  
</div>











        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'XWJACK',
            repo: 'xwjack.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'b1fe01f8c1aed22c0e78e5b65ac4793bb1433707',
            
                client_id: '63a97a6fabe1ee5265d1'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
