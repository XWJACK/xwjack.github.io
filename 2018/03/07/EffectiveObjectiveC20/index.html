<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/head.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png?v=6.3.0">


  <link rel="mask-icon" href="/images/head.png?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="è¯»Effective Objective-C 2.0æœ‰æ„Ÿï¼Œåœ¨è¯»è¿™è¾¹ä¹¦ä¹‹å‰OCçš„åŸºç¡€å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¯ä»¥è¯´ä¸€çªä¸é€šï¼Œæ‰€ä»¥ä¸ä¹ä¸€äº›å¾ˆç®€å•çš„ä¸œè¥¿ã€‚">
<meta name="keywords" content="Objective-C,â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸,ReadBooks">
<meta property="og:type" content="article">
<meta property="og:title" content="Effective Objective-C 2.0">
<meta property="og:url" content="http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/index.html">
<meta property="og:site_name" content="Miniç¬å“†å•¦">
<meta property="og:description" content="è¯»Effective Objective-C 2.0æœ‰æ„Ÿï¼Œåœ¨è¯»è¿™è¾¹ä¹¦ä¹‹å‰OCçš„åŸºç¡€å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¯ä»¥è¯´ä¸€çªä¸é€šï¼Œæ‰€ä»¥ä¸ä¹ä¸€äº›å¾ˆç®€å•çš„ä¸œè¥¿ã€‚">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/2.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/3.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/4.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/5.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/7.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/9.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/8.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/10.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/11.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/14.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/15.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/12.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/13.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/1.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/6.png">
<meta property="og:updated_time" content="2018-04-11T15:31:53.100Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Effective Objective-C 2.0">
<meta name="twitter:description" content="è¯»Effective Objective-C 2.0æœ‰æ„Ÿï¼Œåœ¨è¯»è¿™è¾¹ä¹¦ä¹‹å‰OCçš„åŸºç¡€å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¯ä»¥è¯´ä¸€çªä¸é€šï¼Œæ‰€ä»¥ä¸ä¹ä¸€äº›å¾ˆç®€å•çš„ä¸œè¥¿ã€‚">
<meta name="twitter:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/2.png">






  <link rel="canonical" href="http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Effective Objective-C 2.0 | Miniç¬å“†å•¦</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-80240532-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-80240532-1');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4312600141d9e3d6b344aba925f03a57";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Miniç¬å“†å•¦</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Miniç¬å“†å•¦">
      <meta itemprop="description" content="It's only a matter of time">
      <meta itemprop="image" content="/images/head.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Miniç¬å“†å•¦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Effective Objective-C 2.0
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-03-07 10:31:00" itemprop="dateCreated datePublished" datetime="2018-03-07T10:31:00+08:00">2018-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-04-11 23:31:53" itemprop="dateModified" datetime="2018-04-11T23:31:53+08:00">2018-04-11</time>
              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/07/EffectiveObjectiveC20/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count gitment-comments-count" data-xid="/2018/03/07/EffectiveObjectiveC20/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>è¯»Effective Objective-C 2.0æœ‰æ„Ÿï¼Œåœ¨è¯»è¿™è¾¹ä¹¦ä¹‹å‰OCçš„åŸºç¡€å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¯ä»¥è¯´ä¸€çªä¸é€šï¼Œæ‰€ä»¥ä¸ä¹ä¸€äº›å¾ˆç®€å•çš„ä¸œè¥¿ã€‚</p>
<a id="more"></a>
<h1 id="Accustoming-Yourself-to-Objective-C"><a href="#Accustoming-Yourself-to-Objective-C" class="headerlink" title="Accustoming Yourself to Objective-C"></a>Accustoming Yourself to Objective-C</h1><h2 id="Item-4-Typed-Constants"><a href="#Item-4-Typed-Constants" class="headerlink" title="Item 4: Typed Constants"></a>Item 4: Typed Constants</h2><p>ä¸»è¦ä»‹ç»çš„æ˜¯#defineã€staticã€constã€externã€‚</p>
<ul>
<li>constä¿®é¥°å¸¸é‡ã€‚</li>
<li>staticä¿®é¥°é™æ€å˜é‡<blockquote>
<p>è¿™é‡ŒOCå’ŒSwiftæ˜¯æœ‰åŒºåˆ«çš„ï¼ŒOCçš„staticä¿®é¥°çš„å˜é‡ä¸ä¼šåˆ›å»ºå¤–éƒ¨ç¬¦å·ï¼Œä»…åœ¨è‡ªå·±çš„å®ç°æ–‡ä»¶ä¸­è¿›è¡Œç±»ä¼¼äº#defineçš„æ›¿æ¢ã€‚åœ¨Swiftä¸­ï¼Œstaticè¡¨ç¤ºç±»å˜é‡æˆ–è€…æ˜¯ç±»æ–¹æ³•ã€‚</p>
</blockquote>
</li>
</ul>
<p>å…¸å‹ä½¿ç”¨ğŸŒ°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// xx.m</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">NSString</span> *ABCNotificationName = <span class="string">@"ABCNotificationName"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// xxx.m</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *ABCNotificationName;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™æ ·å°±ä¸ä¼šåœ¨ä¸¤ä¸ªæ— å…³çš„å®ç°æ–‡ä»¶å¯¼å…¥ç›¸å…³å¤´æ–‡ä»¶ã€‚åœ¨è¿™é‡Œä¸èƒ½æ·»åŠ staticä¿®é¥°ç¬¦ï¼Œå¦åˆ™ä¼šå¯¼è‡´externå¤±è´¥ã€‚</p>
</blockquote>
<h1 id="Objects-Messaging-and-the-Runtime"><a href="#Objects-Messaging-and-the-Runtime" class="headerlink" title="Objects, Messaging, and the Runtime"></a>Objects, Messaging, and the Runtime</h1><h2 id="Item-6-Understand-Properties"><a href="#Item-6-Understand-Properties" class="headerlink" title="Item 6: Understand Properties"></a>Item 6: Understand Properties</h2><p>è¿™é‡Œä»‹ç»äº†å±æ€§çš„ç›¸å…³çŸ¥è¯†ï¼Œå½“æ·»åŠ ä¸€ä¸ªå®ä¾‹å˜é‡ä¹‹åï¼Œå­˜å‚¨å®ä¾‹å˜é‡çš„å†…å­˜ç»“æ„å‘ç”Ÿå˜åŒ–ï¼ˆå®ä¾‹å˜é‡åœ¨ç±»ä¸­offsetå‘ç”Ÿå˜åŒ–ï¼‰ã€‚ä¸ºäº†è¿™æ ·çš„æƒ…å†µå‘ç”Ÿï¼ŒOCé‡‡ç”¨è¿è¡Œæ—¶åŠ¨æ€æŸ¥æ‰¾å®ä¾‹å˜é‡çš„offsetæ¥å®ç°ç¨³å®šçš„ABI</p>
<blockquote>
<p>You can even add instance variables to classes at runtime.è¿™å¥è¯è®©æˆ‘ç™¾æ€ä¸å¾—å…¶è§£ï¼Œä¸çŸ¥é“å¦‚ä½•å®ç°ã€‚ï¼ˆobjc_setAssociatedObjectä¹Ÿä¸æ˜¯å‘ç±»ä¸­æ·»åŠ å®ä¾‹å˜é‡å•Šï¼‰<br>Item 27ä¸­æœ‰è¿™æ ·ä¸€æ®µè¯ï¼ŒTherefore, instance variables do not have to be defined in the public interface, since consumers of the class do not have to know their layout.è¯´çš„æ˜¯Extensionï¼Œå¯èƒ½ä½œè€…æƒ³è¯´çš„æ˜¯Extensionå¯ä»¥æ·»åŠ å®ä¾‹å˜é‡ï¼Œä½†æ˜¯Extensionä¸æ˜¯è¿è¡Œæ—¶ã€‚è¿™é‡Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä½œè€…çš„é”™è¯¯ã€‚</p>
</blockquote>
<h2 id="Item-9-Class-Cluster"><a href="#Item-9-Class-Cluster" class="headerlink" title="Item 9: Class Cluster"></a>Item 9: Class Cluster</h2><p>åœ¨çœ‹<a href="/resources/2018-03-07-Effective-Objective-C-2-0/Effective-Objective-C.epub.zip">Effective Objective-C</a>çš„æ—¶å€™çœ‹åˆ°ç±»ç°‡è¿™éƒ¨åˆ†ï¼Œè®©æˆ‘å¯¹Objective-Cä¸­çš„å·¥å‚æ¨¡å¼æœ‰äº†ä¸€å®šçš„è®¤è¯†ï¼Œä¹Ÿè§£å¼€äº†ä»¥å‰çš„ç–‘æƒ‘ï¼ˆæ¯”å¦‚UIButtonã€NSArrayç­‰ï¼‰ã€‚</p>
<p>æ¯”å¦‚åœ¨lldbè°ƒè¯•çš„è¿‡ç¨‹ä¸­çœ‹åˆ°çš„NSArrayç±»å‹å¹¶ä¸æ˜¯NSArrayï¼Œå¯èƒ½æ˜¯ä¸€ä¸ª<code>__NSSingleObjectArrayI</code>ä¹Ÿå¯èƒ½æ˜¯<code>__NSArrayI</code>ï¼Œéƒ½æ˜¯Appleå°è£…åœ¨å†…éƒ¨çš„ç§æœ‰ç±»ï¼Œä»–ä»¬éƒ½æ˜¯NSArrayå­ç±»ï¼Œæ„å‘³ç€NSArrayä»…ä»…æ˜¯ä¸€ä¸ªå£³è€Œå·²ã€‚</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/2.png" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> idArray = @[@<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> ([idArray <span class="keyword">class</span>] == [<span class="built_in">NSArray</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">    <span class="comment">/// ä¸ä¼šæ‰§è¡Œã€‚å› ä¸º[idArray class]è¿”å›ä¸ä¼šæ˜¯NSArrayç±»æœ¬èº«ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¨è<a href="http://blog.sunnyxx.com/2014/12/18/class-cluster/" target="_blank" rel="noopener">ä»NSArrayçœ‹ç±»ç°‡</a>è¿™ç¯‡æ–‡ç« ã€‚</p>
<h2 id="Item-12-Message-Forwarding"><a href="#Item-12-Message-Forwarding" class="headerlink" title="Item 12: Message Forwarding"></a>Item 12: Message Forwarding</h2><p><img src="/images/2018-03-07-Effective-Objective-C-2-0/3.jpg" alt=""></p>
<ol>
<li>é¦–å…ˆè°ƒç”¨<code>resolveInstanceMethod</code>æˆ–è€…<code>resolveClassMethod</code>ï¼Œè¡¨æ˜æ˜¯å¦èƒ½å¤Ÿæ–°å¢ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†ã€‚<blockquote>
<p>Dynamically provides an implementation for a given selector for an instance method.<br>Dynamically provides an implementation for a given selector for a class method.</p>
</blockquote>
</li>
<li>å½“ä¸Šä¸€æ­¥éå†åˆ°NSObjectçš„æ—¶å€™è¿˜æ˜¯è¿”å›NOï¼Œå°±ä¼šè°ƒç”¨<code>forwardingTargetForSelector</code>ï¼Œåœ¨è¿™é‡Œå¯ä»¥å°†æ¶ˆæ¯è½¬å‘ç»™å¦ä¸€ä¸ªå¯¹è±¡ã€‚<blockquote>
<p>Returns the object to which unrecognized messages should first be directed.<br>âš ï¸ è¿™é‡Œä¸è¦è¿”å›selfï¼Œå¦åˆ™ä¼šé™·å…¥æ­»å¾ªç¯ã€‚å¸¸ç”¨çš„æ“ä½œæ˜¯å°†æ¶ˆæ¯è½¬å‘ç»™å†…éƒ¨çš„éšè—çš„å¯¹è±¡ã€‚</p>
</blockquote>
</li>
<li>å½“ä¸Šä¸€æ­¥ç»§ç»­è¿”å›nilçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>forwardInvocation</code>è¿›è¡Œå®Œæ•´çš„æ¶ˆæ¯è½¬å‘ã€‚<blockquote>
<p>Overridden by subclasses to forward messages to other objects.</p>
</blockquote>
</li>
</ol>
<h3 id="resolveInstanceMethod-resolveClassMethod"><a href="#resolveInstanceMethod-resolveClassMethod" class="headerlink" title="resolveInstanceMethod || resolveClassMethod"></a>resolveInstanceMethod || resolveClassMethod</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line">- (<span class="keyword">void</span>)failedDymamic;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(failedDymamic)) &#123;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP) dynamicMethod, <span class="string">"v@:"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> dynamicMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL sel) &#123;</span><br><span class="line">    printf(<span class="string">"Dynamic Method\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> failedDymamic];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼š</li>
</ul>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/4.png" alt=""></p>
<blockquote>
<p>ç”±äºæ²¡æœ‰<code>failedDymamic</code>çš„å®ç°ï¼Œå¯¼è‡´æ— æ³•åœ¨method listä¸­æ‰¾åˆ°å¯¹åº”å®ç°ï¼Œæ‰€ä»¥è°ƒç”¨<code>resolveInstanceMethod</code>å‘method listä¸­åŠ å…¥æ–°çš„<code>dynamicMethod</code>ã€‚</p>
</blockquote>
<ul>
<li>ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼š</li>
</ul>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/5.png" alt=""></p>
<blockquote>
<p>ä¸ç»è¿‡<code>resolveInstanceMethod</code>ï¼Œå› ä¸ºmethod listä¸­å·²ç»æœ‰å¯¹åº”çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨ã€‚</p>
<p>âš ï¸ ä½†æ˜¯method listä¸­å¯¹åº”çš„selä¾æ—§æ˜¯<code>faileæ·¡å®šymamic</code>ï¼Œä½†æ˜¯å®é™…è°ƒç”¨çš„æ˜¯<code>dynamicMethod</code>ï¼Œç›¸å½“äºç›¸åº”çš„æ–¹æ³•è¢«æ›¿æ¢ã€‚</p>
</blockquote>
<h3 id="forwardingTargetForSelector"><a href="#forwardingTargetForSelector" class="headerlink" title="forwardingTargetForSelector"></a>forwardingTargetForSelector</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéšè—çš„å±æ€§ä¸æƒ³è®©å¤–éƒ¨çœ‹åˆ°ï¼Œä½†æ˜¯å¤–éƒ¨éœ€è¦æ¥å£è®¿é—®ï¼Œå…¶ä¸­è£…é€¼çš„æ–¹æ³•å¯ä»¥è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrivateView</span>: <span class="title">UIView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrivateView</span></span></span><br><span class="line">- (<span class="keyword">void</span>)changeColor: (<span class="built_in">UIColor</span> *)color &#123;</span><br><span class="line">    <span class="keyword">self</span>.backgroundColor = color;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) PrivateView *privateView;</span><br><span class="line">- (<span class="keyword">void</span>)changeColor: (<span class="built_in">UIColor</span> *)color;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.privateView = [[PrivateView alloc] initWithFrame:<span class="keyword">self</span>.view.frame];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.privateView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        <span class="comment">/// æ¶ˆæ¯è½¬å‘ï¼Œå°†æ¶ˆæ¯è½¬å‘åˆ°å†…éƒ¨å˜é‡ï¼Œè‡ªå·±å¹¶ä¸å¤„ç†è¯¥äº‹ä»¶ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.privateView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> changeColor:[<span class="built_in">UIColor</span> redColor]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/7.png" alt=""></p>
<blockquote>
<p>âš ï¸ å½“ä¸€æ¬¡<code>forwardingTargetForSelector</code>æˆåŠŸä¹‹åï¼Œå†æ¬¡å‘é€è¯¥æ¶ˆæ¯çš„æ—¶å€™å¹¶ä¸ä¼šé‡æ–°ä»<code>resolveInstanceMethod</code>å¼€å§‹ï¼Œè€Œæ˜¯ç›´æ¥<code>forwardingTargetForSelector</code>ã€‚çŒœæµ‹åº”è¯¥æ˜¯åšäº†ç¼“å­˜ã€‚</p>
</blockquote>
<h3 id="forwardInvocation"><a href="#forwardInvocation" class="headerlink" title="forwardInvocation"></a>forwardInvocation</h3><p>ä»¥ä¸Šéƒ½æ²¡æœ‰ç»“æœï¼Œå°±ä¼šè°ƒç”¨<code>forwardInvocation</code>è¿›è¡Œå®Œæ•´çš„æ¶ˆæ¯è½¬å‘è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>âš ï¸ æ­¤æ—¶å¿…é¡»è¦é‡å†™<code>methodSignatureForSelector</code>è¿”å›å¯¹åº”æ–¹æ³•ç­¾åï¼Œå¦‚æœæ–¹æ³•ç­¾åè¿”å›ä¸ºnilï¼Œåˆ™ä¸ä¼šè°ƒç”¨<code>forwardInvocation</code>ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([anInvocation selector] == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.privateView];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.privateView methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»…ä»…æ˜¯æ¶ˆæ¯çš„ç®€å•è½¬å‘ï¼Œåœ¨è¿™é‡Œå…¶å®æˆ‘ä»¬å¯ä»¥åšæ›´å¤šï¼Œæ¯”å¦‚ä¿®æ”¹å‚æ•°ã€ä¿®æ”¹è¿”å›å€¼ç­‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([anInvocation selector] == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        <span class="built_in">UIColor</span> *color = [<span class="built_in">UIColor</span> greenColor];</span><br><span class="line">        <span class="comment">/// ä¿®æ”¹å‚æ•°ï¼Œå°†èƒŒæ™¯è‰²ä»redä¿®æ”¹æˆgreen 0:self 1:_cmd</span></span><br><span class="line">        [anInvocation setArgument:&amp;color atIndex:<span class="number">2</span>];</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.privateView];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.privateView methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> changeColor:[<span class="built_in">UIColor</span> redColor]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/9.png" alt=""></p>
<blockquote>
<p>ç”±äºæ‰§è¡Œåˆ°è¯¥æ¶ˆæ¯è½¬å‘çš„æ—¶å€™å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œã€‚</p>
</blockquote>
<h4 id="methodSignatureForSelector"><a href="#methodSignatureForSelector" class="headerlink" title="methodSignatureForSelector"></a>methodSignatureForSelector</h4><p>To respond to methods that your object does not itself recognize, you must override methodSignatureForSelector: in addition to forwardInvocation:. The mechanism for forwarding messages uses information obtained from methodSignatureForSelector: to create the NSInvocation object to be forwarded. Your overriding method must provide an appropriate method signature for the given selector, either by pre formulating one or by asking another object for one.</p>
<p>åœ¨ä¸Šé¢class_addMethodçš„æ—¶å€™å‡ºç°äº†<code>&quot;v@:&quot;</code>ä¸œè¥¿ã€‚</p>
<ol>
<li>@encode(BOOL) (c) for the return type</li>
<li>@encode(id) (@) for the receiver (self)</li>
<li>@encode(SEL) (:) for the selector (_cmd)</li>
<li>@encode(NSString *) (@) for the first explicit argument</li>
</ol>
<p>æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ä¸¤ä¸ªé»˜è®¤çš„å‚æ•°ï¼Œä¸€ä¸ªæ˜¯selfï¼Œä¸€ä¸ªæ˜¯_cmdã€‚è€Œé‚£ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºçš„å°±æ˜¯ç±»å‹ç¼–ç ï¼ˆType Encodingsï¼‰ã€‚</p>
<p><code>&quot;v@:&quot;</code>è¡¨ç¤ºçš„å°±æ˜¯è¿”å›å€¼ä¸ºvoidï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯selfï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º_cmdã€‚</p>
<h3 id="doesNotRecognizeSelector"><a href="#doesNotRecognizeSelector" class="headerlink" title="doesNotRecognizeSelector"></a>doesNotRecognizeSelector</h3><p>å½“ä¸Šé¢æ­¥éª¤éƒ½èµ°å®Œäº†ï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ¶ˆæ¯æ¥å—è€…ï¼Œå°±ä¼šè°ƒç”¨NSObjectçš„<code>doesNotRecognizeSelector</code>æ¥æŠ›å‡ºå¼‚å¸¸ã€‚æ—¢â€Terminating app due to uncaught exception â€˜NSInvalidArgumentExceptionâ€™, reason:â€</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/8.png" alt=""></p>
<h2 id="Item-13-Method-Swizzling"><a href="#Item-13-Method-Swizzling" class="headerlink" title="Item 13: Method Swizzling"></a>Item 13: Method Swizzling</h2><p>åœ¨äº†è§£äº†æ¶ˆæ¯è½¬å‘ä¹‹åï¼Œå°±å¾ˆå®¹æ˜“ç†è§£æ–¹æ³•äº¤æ¢ã€‚å°±æ˜¯ä¿®æ”¹Methos Listsã€‚</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/10.jpg" alt=""></p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/11.jpg" alt=""></p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š</p>
<ol>
<li>ä¸ºä»€ä¹ˆè¦åœ¨loadä¸­å®ç°æ–¹æ³•äº¤æ¢ã€‚</li>
<li>loadå’Œinitializeè°ƒç”¨æ—¶æœºã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Begin"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"End"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ObjectA.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ObjectA</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"initialize"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newCreate &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/14.png" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Begin"</span>);</span><br><span class="line">    ObjectA *newCreate = [[ObjectA alloc] init];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"End"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/15.png" alt=""></p>
<p>loadè°ƒç”¨ï¼š</p>
<ol>
<li>Loadåœ¨é•œåƒåŠ è½½çš„æ—¶å€™è°ƒç”¨ã€‚</li>
<li>Loadå…ˆäºmainè°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™Frameworkå·²ç»åŠ è½½äº†ï¼ˆC++é™æ€åº“æ²¡æœ‰ï¼‰ã€‚</li>
<li>çˆ¶ç±»å…ˆäºå­ç±»è°ƒç”¨ã€‚</li>
<li>ç±»å…ˆäºcarthageè°ƒç”¨ã€‚</li>
</ol>
<p>initlizateè°ƒç”¨ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ç±»ï¼Œæˆ–è€…æ˜¯è°ƒç”¨ç±»æ–¹æ³•ç­‰ï¼ˆä¸ªäººç†è§£å°±æ˜¯åˆ›å»ºå…ƒç±»çš„æ—¶å€™ï¼Œå› ä¸ºå…ƒç±»ä¹Ÿå¯ä»¥çœ‹æˆå•ä¾‹ï¼‰ã€‚</li>
<li>å¦‚æœæ²¡æœ‰è°ƒç”¨åˆ™ä¸ä¼šè°ƒç”¨initlizateã€‚</li>
</ol>
<blockquote>
<p><a href="https://github.com/Draveness/analyze/blob/master/contents/objc/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%20load%20%E6%96%B9%E6%B3%95%E4%B9%88%EF%BC%9F.md" target="_blank" rel="noopener">ä½ çœŸçš„äº†è§£ load æ–¹æ³•ä¹ˆï¼Ÿ</a></p>
</blockquote>
<h2 id="Item-14-Objective-C-Object"><a href="#Item-14-Objective-C-Object" class="headerlink" title="Item 14: Objective-C Object"></a>Item 14: Objective-C Object</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *string = <span class="string">@"This is NSString"</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å­—ç¬¦ä¸²</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>string</th>
<th>@â€This is NSStringâ€</th>
</tr>
</thead>
<tbody>
<tr>
<td>å†…å­˜åˆ†é…</td>
<td>æ ˆ</td>
<td>å †</td>
</tr>
<tr>
<td>ç±»å‹</td>
<td>objc_object</td>
<td>objc_class</td>
</tr>
</tbody>
</table>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Classä¸­çš„isaæŒ‡å‘å…¶å…ƒç±»ï¼Œä¹Ÿæ˜¯ç±»æ–¹æ³•å®š<!-- more --><!-- more -->ä¹‰çš„åœ°æ–¹ï¼Œåªæœ‰ä¸€ä¸ªå®ä¾‹å…³è”å…ƒç±»ï¼ˆå¯ä»¥è®¤ä¸ºç±»æ–¹æ³•çš„è°ƒç”¨ç±»ä¼¼äºå•ä¾‹è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼‰ã€‚æ‰€ä»¥ä¸‹é¢çš„åˆ¤æ–­æ–¹æ³•æ˜¯æ­£ç¡®çš„ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> object = <span class="comment">/*...*/</span>;</span><br><span class="line"><span class="keyword">if</span> ([object <span class="keyword">class</span>] == [AClass <span class="keyword">class</span>]) &#123;</span><br><span class="line">    <span class="comment">// 'object' is an instance of AClass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>âš ï¸ è¿™ç§æ–¹å¼ä»…å¯¹NSObjectå­ç±»æœ‰æ•ˆï¼Œå¦‚æœç±»æ˜¯ç»§æ‰¿äºNSProxyï¼Œåˆ™ä¸é€‚ç”¨ã€‚</p>
</blockquote>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/12.jpg" alt=""></p>
<h1 id="Interface-and-API-Design"><a href="#Interface-and-API-Design" class="headerlink" title="Interface and API Design"></a>Interface and API Design</h1><h2 id="Item-18-Prefer-Immutable-Objects"><a href="#Item-18-Prefer-Immutable-Objects" class="headerlink" title="Item 18: Prefer Immutable Objects"></a>Item 18: Prefer Immutable Objects</h2><p>Swiftä¸­æˆ‘è§‰å¾—æœ€å¥½çš„æ˜¯æƒé™æ§åˆ¶ï¼Œç”±äºSwiftä»¥æ–‡ä»¶ä¸ºå•ä½è¿›è¡Œæƒé™æ§åˆ¶ã€‚ä¾‹å¦‚<code>private</code>ã€<code>fileprivate</code>ç­‰ã€‚å†…éƒ¨è¯»å†™ï¼Œå¤–éƒ¨è¯»å–æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>private(set)</code>ã€<code>fileprivate(set)</code>è¿™æ ·çš„æ–¹å¼ã€‚åˆšæ¥è§¦OCçš„æ—¶å€™å¾ˆæ˜¯å›°æƒ‘ï¼Œç›´åˆ°æˆ‘æ˜ç™½OCçš„åŠ¨æ€æ€§å’ŒRuntimeç­‰ç›¸å…³çŸ¥è¯†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">A</span></span></span><br><span class="line"><span class="comment">/// åªè¯»å±æ€§</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *string;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">A</span> ()</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readwrite</span>) <span class="built_in">NSString</span> *string;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">   <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">       <span class="keyword">self</span>.string = <span class="string">@"Jack"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æä¾›ä¸ªäººçš„ç†è§£ï¼š</p>
<ol>
<li>Runtimeçš„å­˜åœ¨ä½¿å¾—OCå…·æœ‰åŠ¨æ€æ€§ï¼Œç›´åˆ°è¿è¡Œæ—¶æ‰çŸ¥é“å¦‚ä½•è¿›è¡Œæ¶ˆæ¯æ´¾å‘ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™æ˜¯å¹¶ä¸çŸ¥é“çš„ã€‚</li>
<li>å¤´æ–‡ä»¶çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œå…¶ä»–äººå¯ä»¥å°è¯•è°ƒç”¨ï¼Œä½†æ˜¯æœ‰æ²¡æœ‰å®ç°æˆ‘å¹¶ä¸å‘Šè¯‰åˆ«äººï¼Œç›´åˆ°è¿è¡Œæ—¶æ‰å‘Šè¯‰ä½ ã€‚</li>
<li>Extensionå…¶å®æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™è¿›è¡Œçš„ï¼Œç›®çš„å°±æ˜¯éšè—å…·ä½“çš„ç»†èŠ‚ã€‚</li>
</ol>
<blockquote>
<p>å®ç°æ–‡ä»¶ç”¨æ¥ç¼–è¯‘ï¼Œå¤´æ–‡ä»¶ç”¨æ¥é“¾æ¥å…¶ä»–æ–‡ä»¶ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å†æ¥åˆ†æä¸Šé¢çš„ä»£ç ï¼Œåœ¨å¤´æ–‡ä»¶å£°æ˜å±æ€§ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”ŸæˆgetStringæ–¹æ³•ï¼Œå…¶ä»–äººçœ‹åˆ°ä¹Ÿå°±åªæœ‰è¿™ä¸ªã€‚åœ¨å®ç°æ–‡ä»¶ä¸­å£°æ˜ç›¸åŒå±æ€§ï¼Œç¼–è¯‘å™¨ä¼šå£°æ˜getStringå’ŒsetStringä¸¤ä¸ªæ–¹æ³•ï¼Œåªæœ‰è‡ªå·±çŸ¥é“ã€‚æ‰€ä»¥ä¹Ÿå°±å®ç°äº†ç±»ä¼¼äºSwiftçš„å†…éƒ¨è¯»å†™ï¼Œå¤–éƒ¨è¯»å–ã€‚ä½†æ˜¯è¿™ä¸ªsetStringæ–¹æ³•åœ¨Runtimeçš„æ˜¯å¯ä»¥åœ¨æ–¹æ³•è¡¨ä¸­æ‰¾åˆ°çš„ï¼Œæ„å‘³ç€æˆ‘ä»¬å‘å…¶å‘é€setStringæ¶ˆæ¯ï¼Œæ˜¯èƒ½å¤Ÿå“åº”çš„ï¼ˆæˆ–è€…é€šè¿‡KVCï¼‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectA *a = [[ObjectA alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br><span class="line"><span class="comment">/// å‘å…¶å‘é€setStringæ¶ˆæ¯ï¼ŒThese functions must be cast to an appropriate function pointer type before being called.</span></span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))objc_msgSend)(a, sel_registerName(<span class="string">"setString:"</span>), <span class="string">@"Sparrow"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br><span class="line">[a setValue:<span class="string">@"Jack"</span> forKey:<span class="string">@"string"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/13.png" alt=""></p>
<h2 id="Advances"><a href="#Advances" class="headerlink" title="Advances"></a>Advances</h2><h3 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Basic Messaging Primitives</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_stret for some struct return types.</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_fpret for some float return types.</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_fp2ret for some float return types.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These functions must be cast to an appropriate function pointer type </span></span><br><span class="line"><span class="comment"> * before being called. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#if !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line">OBJC_EXPORT <span class="keyword">void</span></span><br><span class="line">objc_msgSend(<span class="keyword">void</span> <span class="comment">/* id self, SEL op, ... */</span> )</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»objc_msgSendå®šä¹‰çœ‹å‡ºï¼Œå…¶å¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„å‡½æ•°ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™éœ€è¦ç»™å‡ºæŒ‡å®šçš„å‡½æ•°æŒ‡é’ˆç±»å‹ã€‚</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ç¼–è¯‘å™¨æ˜¯å¦‚ä½•ä¸ºæˆ‘ä»¬è§£å†³ä»£ç åˆ°æ¶ˆæ¯çš„è½¬æ¢ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.h</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">   ObjectA *a = [[ObjectA alloc] init];</span><br><span class="line">   <span class="comment">/// å…¶å®æ˜å¹¶æ²¡æœ‰åšä»»ä½•äº‹ï¼Œä»…ä»…åœ¨å¤´æ–‡ä»¶å£°æ˜ï¼Œè®©ç¼–è¯‘å™¨çŸ¥é“æœ‰è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">   [a setA: <span class="string">@"Sparrow"</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> clang -rewrite-objc main.m</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.cpp</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">   ObjectA *a = ((ObjectA *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((ObjectA *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"ObjectA"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>));</span><br><span class="line">   ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">NSString</span> *))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)a, sel_registerName(<span class="string">"setA:"</span>), (<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_8j_r22m5hzd7lj4qz9prr3q1qlw0000gn_T_main_1cdde1_mi_0);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°æŒ‡é’ˆç±»å‹æ˜¯<code>(void (*)(id, SEL, NSString *)</code>ï¼Œ<code>sel_registerName</code>é€šè¿‡ç»™å®šçš„<code>&quot;setA:&quot;</code>å­—ç¬¦ä¸²ç”Ÿæˆä¸€ä¸ªSELï¼Œä¹‹åæ˜¯ä¼ é€’çš„å‚æ•°ã€‚è¿™æ ·å°±å®ç°äº†æ¶ˆæ¯å‘é€ã€‚</p>
<blockquote>
<p><a href="http://yaoqi-github.github.io/20160417/runtim-objc_msgSend%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">runtime objc_msgSendä½¿ç”¨</a></p>
</blockquote>
<h3 id="Extension-Class-continuation-Category-amp-amp-Category"><a href="#Extension-Class-continuation-Category-amp-amp-Category" class="headerlink" title="Extension(Class-continuation Category) &amp;&amp; Category"></a>Extension(Class-continuation Category) &amp;&amp; Category</h3><ol>
<li>Extensionï¼ˆç¼–è¯‘æœŸé—´ï¼‰ï¼ŒCategoryï¼ˆè¿è¡Œæ—¶æœŸé—´ï¼‰ã€‚<blockquote>
<p>æ‰€ä»¥Extensionå¯ä»¥æ·»åŠ å®ä¾‹å˜é‡è€ŒCategoryä¸èƒ½ã€‚</p>
</blockquote>
</li>
<li>Extensionå’ŒCategoryéƒ½å¯ä»¥æ·»åŠ å±æ€§ã€‚<blockquote>
<p>ä½†æ˜¯åªæœ‰Extensionå¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„å®ä¾‹å˜é‡å’Œå­˜å‚¨æ–¹æ³•ï¼Œè€ŒCategoryä¸ä¼šç”Ÿæˆå®ä¾‹å˜é‡å’Œå­˜å‚¨æ–¹æ³•ï¼Œåªæœ‰ä¸€ä¸ªå­˜å‚¨æ–¹æ³•çš„å£°æ˜ï¼Œéœ€è¦è‡ªå·±å»æ‰‹åŠ¨å®ç°ã€‚<br>å¦‚æœæ²¡æœ‰æ‰‹åŠ¨å®ç°å°±ä¼šå‡ºç°è­¦å‘ŠProperty â€˜privateStringâ€™ requires method â€˜privateStringâ€™ to be defined - use @dynamic or provide a method implementation in this category</p>
</blockquote>
</li>
<li>å¦‚æœCategoryæ·»åŠ çš„æ–¹æ³•å’ŒåŸç±»ä¸­çš„æ–¹æ³•æ˜¯åŒåçš„ï¼Œé‚£ä¹ˆä¼šè¦†ç›–ï¼ˆ<strong>æœ€ååœ¨è¿è¡Œæ—¶åŠ è½½çš„æ—¶å€™Categoryçš„æ–¹æ³•è¡¨ä¼šåœ¨åŸæ–¹æ³•è¡¨å‰é¢ï¼Œå¯¼è‡´è¢«è¦†ç›–çš„ç°è±¡ï¼Œå…¶å®åŸæ–¹æ³•è¿˜æ˜¯å­˜åœ¨çš„</strong>ï¼‰åŸæœ‰ç±»ä¸­æ–¹æ³•çš„å®ç°ã€‚</li>
</ol>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™ä¸ªç»“æ„ï¼Œåˆ™<code>objc_ivar_list</code>æŒ‡å‘çš„æ˜¯å®ä¾‹å˜é‡è¡¨ï¼Œ<code>objc_method_list</code>æŒ‡å‘çš„å®ä¾‹æ–¹æ³•è¡¨æŒ‡é’ˆã€‚ä¸¤è€…çš„åŒºåˆ«å¯¼è‡´äº†æˆ‘ä»¬åªèƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹å®ä¾‹æ–¹æ³•è¡¨ï¼Œè€Œä¸èƒ½ä¿®æ”¹å®ä¾‹å˜é‡è¡¨ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_ivar &#123;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_type                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_ivar_list &#123;</span><br><span class="line">    <span class="keyword">int</span> ivar_count                                           OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar ivar_list[<span class="number">1</span>]                            OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable method_types                            OBJC2_UNAVAILABLE;</span><br><span class="line">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_method_list &#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable obsolete             OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> method_count                                         OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>]                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨è¿è¡ŒæœŸï¼Œå¯¹è±¡å†…å­˜å¸ƒå±€å·²ç»ç¡®å®šã€‚</p>
</blockquote>
<p>ä»categoryä¸­å¯ä»¥çœ‹å‡ºå¹¶ä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> category_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    classref_t cls;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;</span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;</span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">struct</span> property_list_t *_classProperties;</span><br><span class="line"></span><br><span class="line">    method_list_t *methodsForMeta(<span class="keyword">bool</span> isMeta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_list_t *propertiesForMeta(<span class="keyword">bool</span> isMeta, <span class="keyword">struct</span> header_info *hi);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a></p>
</blockquote>
<h1 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h1><h2 id="Item-30-ARC"><a href="#Item-30-ARC" class="headerlink" title="Item 30 ARC"></a>Item 30 ARC</h2><p>å½“æ–¹æ³•åå­—æ˜¯ä»¥ä¸‹é¢åå­—ä¸ºå¼€å¤´ï¼Œåˆ™è¿”å›çš„å¯¹è±¡äº¤ç”±è°ƒç”¨è€…ç®¡ç†ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å›çš„å¯¹è±¡ä¸ºautoreleaseå¯¹è±¡ã€‚</p>
<ol>
<li>alloc</li>
<li>new</li>
<li>copy</li>
<li>mutableCopy</li>
</ol>
<p>ä¸¾ä¸ªğŸŒ°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ObjectA.m</span></span><br><span class="line"><span class="comment">/// å¾ˆç®€å•ï¼Œä¸¤ä¸ªç±»æ–¹æ³•ï¼Œè¿”å›å½“å‰å®ä¾‹ï¼Œæ³¨æ„å‘½å</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ObjectA</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newCreate;  <span class="comment">// return [[self alloc] init];</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)create;     <span class="comment">// return [[self alloc] init];</span></span><br><span class="line">- (<span class="keyword">void</span>)testFunction;       <span class="comment">// NSLog(@"Test Function"); </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    ObjectA *newCreate = [ObjectA newCreate];</span><br><span class="line">    ObjectA *create = [ObjectA create];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨clangå°†ObjectA.mæ–‡ä»¶ç¼–è¯‘æˆLLVMä¸­é—´æ–‡ä»¶ã€‚</span></span><br><span class="line">$ clang -S -fobjc-arc -emit-llvm ObjectA.m -o ObjectA.ll</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">define internal i8* @&quot;\01+[ObjectA newCreate]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %7 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %5, i8* %6)</span><br><span class="line">  %9 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %7, i8* %8)</span><br><span class="line">  ret i8* %11</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal i8* @&quot;\01+[ObjectA create]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %7 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %5, i8* %6)</span><br><span class="line">  %9 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %7, i8* %8)</span><br><span class="line">  %12 = tail call i8* @objc_autoreleaseReturnValue(i8* %11) #2</span><br><span class="line">  ret i8* %12</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨clangå°†main.mæ–‡ä»¶ç¼–è¯‘æˆLLVMä¸­é—´æ–‡ä»¶ã€‚</span></span><br><span class="line">$ clang -S -fobjc-arc -emit-llvm main.m -o main.ll</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 &#123;</span><br><span class="line">  %11 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)</span><br><span class="line">  %16 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %15, i8* %14)</span><br><span class="line">  %17 = call i8* @objc_retainAutoreleasedReturnValue(i8* %16) #2</span><br><span class="line">  call void @objc_storeStrong(i8** %19, i8* null) #2</span><br><span class="line">  call void @objc_storeStrong(i8** %20, i8* null) #2</span><br><span class="line">  ret i32 %21</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºåŒä¸€ä¸ªå®ä¾‹ä»…ä»…æ˜¯å‘½åä¸åŒï¼Œç¼–è¯‘çš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚<br>newå¼€å¤´çš„æ–¹æ³•æ˜¯ç›´æ¥è¿”å›å¯¹è±¡çš„ï¼Œæ„å‘³ç€ç”±è°ƒç”¨è€…ç®¡ç†è¿”å›å¯¹è±¡çš„å†…å­˜ï¼Œå¯¹è±¡ä¸º<strong>strongç±»å‹ï¼Œæ‰€ä»¥è¿”å›çš„å¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º1ã€‚<br>énewå¼€å¤´çš„æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªautoreleaseå¯¹è±¡ï¼ˆå¼•ç”¨è®¡æ•°ä¸º0ï¼‰ï¼Œä½†æ˜¯ç”±äºcreateå¯¹è±¡ä¸º</strong>strongç±»å‹ï¼Œæ‰€ä»¥åšäº†ä¸€æ¬¡objc_retainAutoreleasedReturnValueæ“ä½œã€‚<br>ç›¸åŒç‚¹æ˜¯åœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™è°ƒç”¨objc_storeStrongå°†å¯¹è±¡é‡Šæ”¾ã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ï¼Œå†ç»“åˆä¹¦ä¸­çš„ä»£ç åˆ†æ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Same as objc_retainAutorelease but suitable for tail-calling </span></span><br><span class="line"><span class="comment">// if you don't want to push a frame before this point.</span></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="keyword">static</span> id </span><br><span class="line">objc_retainAutoreleaseAndReturn(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_retainAutorelease(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare a value at +1 for return through a +0 autoreleasing convention.</span></span><br><span class="line">id </span><br><span class="line">objc_autoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus1)) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare a value at +0 for return through a +0 autoreleasing convention.</span></span><br><span class="line">id </span><br><span class="line">objc_retainAutoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus0)) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// not objc_autoreleaseReturnValue(objc_retain(obj)) </span></span><br><span class="line">    <span class="comment">// because we don't need another optimization attempt</span></span><br><span class="line">    <span class="keyword">return</span> objc_retainAutoreleaseAndReturn(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">objc_retainAutorelease(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(objc_retain(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/1.jpg" alt=""></p>
<blockquote>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºç¼–è¯‘å™¨å¯¹autoreleaseè¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<ol>
<li>å¦‚æœè¯¥å¯¹è±¡è¿”å›çš„å¯¹è±¡æ˜¯__strongç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å¯¹è±¡ã€‚</li>
<li>å¦‚æœè¯¥å¯¹è±¡è¿”å›çš„å¯¹è±¡æ˜¯__weakç±»å‹ï¼Œåˆ™è¿”å›çš„å¯¹è±¡ä¸ºautoreleaseå¯¹è±¡ã€‚</li>
</ol>
</blockquote>
<h3 id="weak"><a href="#weak" class="headerlink" title="weak"></a>weak</h3><p>é¦–å…ˆæˆ‘ä»¬è¯å®ä¸€ä¸‹ä¸Šé¢çš„é—®é¢˜ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/// âš ï¸ main.m:13:21: warning: assigning retained object to weak variable; object will be released after assignmentã€‚</span></span><br><span class="line">    ObjectA *__<span class="keyword">weak</span> newCreate = [ObjectA newCreate];</span><br><span class="line">    [newCreate testFunction];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    ObjectA *__<span class="keyword">weak</span> create = [ObjectA create];</span><br><span class="line">    [create testFunction];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 personality i8* bitcast (i32 (...)* @__objc_personality_v0 to i8*) &#123;</span><br><span class="line">  %12 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %11, i8* %10)</span><br><span class="line">  %16 = call i8* @objc_initWeak(i8** %14, i8* %15) #2</span><br><span class="line">  call void @objc_release(i8* %17) #2, !clang.imprecise_release !7</span><br><span class="line">  %19 = call i8* @objc_loadWeakRetained(i8** %18) #2</span><br><span class="line">  invoke void bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to void (i8*, i8*)*)(i8* %22, i8* %21)</span><br><span class="line">  ...</span><br><span class="line">  call void @objc_destroyWeak(i8** %25) #2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 personality i8* bitcast (i32 (...)* @__objc_personality_v0 to i8*) &#123;</span><br><span class="line">  %12 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %11, i8* %10)</span><br><span class="line">  %13 = call i8* @objc_retainAutoreleasedReturnValue(i8* %12) #2</span><br><span class="line">  %17 = call i8* @objc_initWeak(i8** %15, i8* %16) #2</span><br><span class="line">  call void @objc_release(i8* %18) #2, !clang.imprecise_release !7</span><br><span class="line">  %20 = call i8* @objc_loadWeakRetained(i8** %19) #2</span><br><span class="line">  invoke void bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to void (i8*, i8*)*)(i8* %23, i8* %22)</span><br><span class="line">          to label %24 unwind label %28</span><br><span class="line">  ...</span><br><span class="line">  call void @objc_destroyWeak(i8** %25) #2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/6.png" alt=""></p>
<blockquote>
<p>ä¸¤ä¸ªåŒæ ·çš„å®ä¾‹ä¸€ä¸ªæœ‰è­¦å‘Šæ— ä»»ä½•çš„è¾“å‡ºç»“æœï¼Œä¸€ä¸ªæ²¡æœ‰è­¦å‘Šï¼Œæ­£å¸¸è¾“å‡ºã€‚</p>
<p>åŸå› å°±åœ¨äºç¬¬äºŒä¸ªåˆ›å»ºçš„å®ä¾‹æ˜¯ä¸€ä¸ªautoreleaseå¯¹è±¡ï¼Œè€Œç¬¬ä¸€ä¸ªåˆ›å»ºçš„å¯¹è±¡ç”±äºå¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‰€ä»¥ä¸€åˆ›å»ºå°±è¢«é‡Šæ”¾æ‰äº†ã€‚</p>
</blockquote>
<p><a href="http://luoxianming.cn/2017/05/06/arc/" target="_blank" rel="noopener">æ¢ç©¶ARC</a></p>
<p><a href="https://clang.llvm.org/docs/AutomaticReferenceCounting.html" target="_blank" rel="noopener">Objective-C Automatic Reference Counting (ARC)</a></p>
<p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener">é»‘å¹•èƒŒåçš„Autorelease</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
            <a href="/tags/â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸/" rel="tag"># â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</a>
          
            <a href="/tags/ReadBooks/" rel="tag"># ReadBooks</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/02/LLDB/" rel="next" title="LLDB">
                <i class="fa fa-chevron-left"></i> LLDB
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/26/BTC/" rel="prev" title="BTC">
                BTC <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.png"
                alt="Miniç¬å“†å•¦" />
            
              <p class="site-author-name" itemprop="name">Miniç¬å“†å•¦</p>
              <p class="site-description motion-element" itemprop="description">It's only a matter of time</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/XWJACK/" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Accustoming-Yourself-to-Objective-C"><span class="nav-number">1.</span> <span class="nav-text">Accustoming Yourself to Objective-C</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-4-Typed-Constants"><span class="nav-number">1.1.</span> <span class="nav-text">Item 4: Typed Constants</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Objects-Messaging-and-the-Runtime"><span class="nav-number">2.</span> <span class="nav-text">Objects, Messaging, and the Runtime</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-6-Understand-Properties"><span class="nav-number">2.1.</span> <span class="nav-text">Item 6: Understand Properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-9-Class-Cluster"><span class="nav-number">2.2.</span> <span class="nav-text">Item 9: Class Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-12-Message-Forwarding"><span class="nav-number">2.3.</span> <span class="nav-text">Item 12: Message Forwarding</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveInstanceMethod-resolveClassMethod"><span class="nav-number">2.3.1.</span> <span class="nav-text">resolveInstanceMethod || resolveClassMethod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forwardingTargetForSelector"><span class="nav-number">2.3.2.</span> <span class="nav-text">forwardingTargetForSelector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forwardInvocation"><span class="nav-number">2.3.3.</span> <span class="nav-text">forwardInvocation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#methodSignatureForSelector"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">methodSignatureForSelector</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doesNotRecognizeSelector"><span class="nav-number">2.3.4.</span> <span class="nav-text">doesNotRecognizeSelector</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-13-Method-Swizzling"><span class="nav-number">2.4.</span> <span class="nav-text">Item 13: Method Swizzling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-14-Objective-C-Object"><span class="nav-number">2.5.</span> <span class="nav-text">Item 14: Objective-C Object</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Interface-and-API-Design"><span class="nav-number">3.</span> <span class="nav-text">Interface and API Design</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-18-Prefer-Immutable-Objects"><span class="nav-number">3.1.</span> <span class="nav-text">Item 18: Prefer Immutable Objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advances"><span class="nav-number">3.2.</span> <span class="nav-text">Advances</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-msgSend"><span class="nav-number">3.2.1.</span> <span class="nav-text">objc_msgSend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extension-Class-continuation-Category-amp-amp-Category"><span class="nav-number">3.2.2.</span> <span class="nav-text">Extension(Class-continuation Category) &amp;&amp; Category</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Memory-Management"><span class="nav-number">4.</span> <span class="nav-text">Memory Management</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Item-30-ARC"><span class="nav-number">4.1.</span> <span class="nav-text">Item 30 ARC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#weak"><span class="nav-number">4.1.1.</span> <span class="nav-text">weak</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 â€“ <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Miniç¬å“†å•¦</span>

  

  
</div>











        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'XWJACK',
            repo: 'xwjack.github.io',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'b1fe01f8c1aed22c0e78e5b65ac4793bb1433707',
            
                client_id: '63a97a6fabe1ee5265d1'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
