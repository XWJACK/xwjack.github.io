<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Effective Objective-C 2.0 | Mini灬哆啦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="读Effective Objective-C 2.0有感，在读这边书之前OC的基础并不是很好，可以说一窍不通，所以不乏一些很简单的东西。">
<meta name="keywords" content="⭐️⭐️⭐️⭐️⭐️,Objective-C,ReadBooks">
<meta property="og:type" content="article">
<meta property="og:title" content="Effective Objective-C 2.0">
<meta property="og:url" content="http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/index.html">
<meta property="og:site_name" content="Mini灬哆啦">
<meta property="og:description" content="读Effective Objective-C 2.0有感，在读这边书之前OC的基础并不是很好，可以说一窍不通，所以不乏一些很简单的东西。">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/2.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/3.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/4.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/5.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/7.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/9.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/8.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/10.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/11.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/14.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/15.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/12.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/13.png">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/1.jpg">
<meta property="og:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/6.png">
<meta property="og:updated_time" content="2018-04-11T15:31:53.100Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Effective Objective-C 2.0">
<meta name="twitter:description" content="读Effective Objective-C 2.0有感，在读这边书之前OC的基础并不是很好，可以说一窍不通，所以不乏一些很简单的东西。">
<meta name="twitter:image" content="http://xwjack.github.io/images/2018-03-07-Effective-Objective-C-2-0/2.png">
  
    <link rel="alternative" href="/atom.xml" title="Mini灬哆啦" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">Mini灬哆啦</a></h1>
        </hgroup>

        
        
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github" target="_blank" href="https://github.com/XWJACK" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                
                

                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">Mini灬哆啦</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">Mini灬哆啦</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/XWJACK" title="github">github</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-EffectiveObjectiveC20" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2018/03/07/EffectiveObjectiveC20/" class="article-date">
      <time datetime="2018-03-07T02:31:00.000Z" itemprop="datePublished">2018-03-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Effective Objective-C 2.0
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Objective-C/">Objective-C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ReadBooks/">ReadBooks</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/⭐️⭐️⭐️⭐️⭐️/">⭐️⭐️⭐️⭐️⭐️</a></li></ul>
    </div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>读Effective Objective-C 2.0有感，在读这边书之前OC的基础并不是很好，可以说一窍不通，所以不乏一些很简单的东西。</p>
<a id="more"></a>
<h1 id="Accustoming-Yourself-to-Objective-C"><a href="#Accustoming-Yourself-to-Objective-C" class="headerlink" title="Accustoming Yourself to Objective-C"></a>Accustoming Yourself to Objective-C</h1><h2 id="Item-4-Typed-Constants"><a href="#Item-4-Typed-Constants" class="headerlink" title="Item 4: Typed Constants"></a>Item 4: Typed Constants</h2><p>主要介绍的是#define、static、const、extern。</p>
<ul>
<li>const修饰常量。</li>
<li>static修饰静态变量<blockquote>
<p>这里OC和Swift是有区别的，OC的static修饰的变量不会创建外部符号，仅在自己的实现文件中进行类似于#define的替换。在Swift中，static表示类变量或者是类方法。</p>
</blockquote>
</li>
</ul>
<p>典型使用🌰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// xx.m</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">NSString</span> *ABCNotificationName = <span class="string">@"ABCNotificationName"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// xxx.m</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">NSString</span> *ABCNotificationName;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样就不会在两个无关的实现文件导入相关头文件。在这里不能添加static修饰符，否则会导致extern失败。</p>
</blockquote>
<h1 id="Objects-Messaging-and-the-Runtime"><a href="#Objects-Messaging-and-the-Runtime" class="headerlink" title="Objects, Messaging, and the Runtime"></a>Objects, Messaging, and the Runtime</h1><h2 id="Item-6-Understand-Properties"><a href="#Item-6-Understand-Properties" class="headerlink" title="Item 6: Understand Properties"></a>Item 6: Understand Properties</h2><p>这里介绍了属性的相关知识，当添加一个实例变量之后，存储实例变量的内存结构发生变化（实例变量在类中offset发生变化）。为了这样的情况发生，OC采用运行时动态查找实例变量的offset来实现稳定的ABI</p>
<blockquote>
<p>You can even add instance variables to classes at runtime.这句话让我百思不得其解，不知道如何实现。（objc_setAssociatedObject也不是向类中添加实例变量啊）<br>Item 27中有这样一段话，Therefore, instance variables do not have to be defined in the public interface, since consumers of the class do not have to know their layout.说的是Extension，可能作者想说的是Extension可以添加实例变量，但是Extension不是运行时。这里不知道是不是作者的错误。</p>
</blockquote>
<h2 id="Item-9-Class-Cluster"><a href="#Item-9-Class-Cluster" class="headerlink" title="Item 9: Class Cluster"></a>Item 9: Class Cluster</h2><p>在看<a href="/resources/2018-03-07-Effective-Objective-C-2-0/Effective-Objective-C.epub.zip">Effective Objective-C</a>的时候看到类簇这部分，让我对Objective-C中的工厂模式有了一定的认识，也解开了以前的疑惑（比如UIButton、NSArray等）。</p>
<p>比如在lldb调试的过程中看到的NSArray类型并不是NSArray，可能是一个<code>__NSSingleObjectArrayI</code>也可能是<code>__NSArrayI</code>，都是Apple封装在内部的私有类，他们都是NSArray子类，意味着NSArray仅仅是一个壳而已。</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/2.png" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> idArray = @[@<span class="number">1</span>];</span><br><span class="line"><span class="keyword">if</span> ([idArray <span class="keyword">class</span>] == [<span class="built_in">NSArray</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">    <span class="comment">/// 不会执行。因为[idArray class]返回不会是NSArray类本身。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>推荐<a href="http://blog.sunnyxx.com/2014/12/18/class-cluster/" target="_blank" rel="noopener">从NSArray看类簇</a>这篇文章。</p>
<h2 id="Item-12-Message-Forwarding"><a href="#Item-12-Message-Forwarding" class="headerlink" title="Item 12: Message Forwarding"></a>Item 12: Message Forwarding</h2><p><img src="/images/2018-03-07-Effective-Objective-C-2-0/3.jpg" alt=""></p>
<ol>
<li>首先调用<code>resolveInstanceMethod</code>或者<code>resolveClassMethod</code>，表明是否能够新增一个方法来处理。<blockquote>
<p>Dynamically provides an implementation for a given selector for an instance method.<br>Dynamically provides an implementation for a given selector for a class method.</p>
</blockquote>
</li>
<li>当上一步遍历到NSObject的时候还是返回NO，就会调用<code>forwardingTargetForSelector</code>，在这里可以将消息转发给另一个对象。<blockquote>
<p>Returns the object to which unrecognized messages should first be directed.<br>⚠️ 这里不要返回self，否则会陷入死循环。常用的操作是将消息转发给内部的隐藏的对象。</p>
</blockquote>
</li>
<li>当上一步继续返回nil的时候，会调用<code>forwardInvocation</code>进行完整的消息转发。<blockquote>
<p>Overridden by subclasses to forward messages to other objects.</p>
</blockquote>
</li>
</ol>
<h3 id="resolveInstanceMethod-resolveClassMethod"><a href="#resolveInstanceMethod-resolveClassMethod" class="headerlink" title="resolveInstanceMethod || resolveClassMethod"></a>resolveInstanceMethod || resolveClassMethod</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line">- (<span class="keyword">void</span>)failedDymamic;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(failedDymamic)) &#123;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP) dynamicMethod, <span class="string">"v@:"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> dynamicMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL sel) &#123;</span><br><span class="line">    printf(<span class="string">"Dynamic Method\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> failedDymamic];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一次点击：</li>
</ul>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/4.png" alt=""></p>
<blockquote>
<p>由于没有<code>failedDymamic</code>的实现，导致无法在method list中找到对应实现，所以调用<code>resolveInstanceMethod</code>向method list中加入新的<code>dynamicMethod</code>。</p>
</blockquote>
<ul>
<li>第二次点击：</li>
</ul>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/5.png" alt=""></p>
<blockquote>
<p>不经过<code>resolveInstanceMethod</code>，因为method list中已经有对应的方法，所以直接调用。</p>
<p>⚠️ 但是method list中对应的sel依旧是<code>faile淡定ymamic</code>，但是实际调用的是<code>dynamicMethod</code>，相当于相应的方法被替换。</p>
</blockquote>
<h3 id="forwardingTargetForSelector"><a href="#forwardingTargetForSelector" class="headerlink" title="forwardingTargetForSelector"></a>forwardingTargetForSelector</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 假设我们有一个隐藏的属性不想让外部看到，但是外部需要接口访问，其中装逼的方法可以进行消息转发。</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PrivateView</span>: <span class="title">UIView</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PrivateView</span></span></span><br><span class="line">- (<span class="keyword">void</span>)changeColor: (<span class="built_in">UIColor</span> *)color &#123;</span><br><span class="line">    <span class="keyword">self</span>.backgroundColor = color;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) PrivateView *privateView;</span><br><span class="line">- (<span class="keyword">void</span>)changeColor: (<span class="built_in">UIColor</span> *)color;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.privateView = [[PrivateView alloc] initWithFrame:<span class="keyword">self</span>.view.frame];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.privateView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        <span class="comment">/// 消息转发，将消息转发到内部变量，自己并不处理该事件。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.privateView;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> changeColor:[<span class="built_in">UIColor</span> redColor]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/7.png" alt=""></p>
<blockquote>
<p>⚠️ 当一次<code>forwardingTargetForSelector</code>成功之后，再次发送该消息的时候并不会重新从<code>resolveInstanceMethod</code>开始，而是直接<code>forwardingTargetForSelector</code>。猜测应该是做了缓存。</p>
</blockquote>
<h3 id="forwardInvocation"><a href="#forwardInvocation" class="headerlink" title="forwardInvocation"></a>forwardInvocation</h3><p>以上都没有结果，就会调用<code>forwardInvocation</code>进行完整的消息转发过程。</p>
<blockquote>
<p>⚠️ 此时必须要重写<code>methodSignatureForSelector</code>返回对应方法签名，如果方法签名返回为nil，则不会调用<code>forwardInvocation</code>。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([anInvocation selector] == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.privateView];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.privateView methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面仅仅是消息的简单转发，在这里其实我们可以做更多，比如修改参数、修改返回值等。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([anInvocation selector] == <span class="keyword">@selector</span>(changeColor:)) &#123;</span><br><span class="line">        <span class="built_in">UIColor</span> *color = [<span class="built_in">UIColor</span> greenColor];</span><br><span class="line">        <span class="comment">/// 修改参数，将背景色从red修改成green 0:self 1:_cmd</span></span><br><span class="line">        [anInvocation setArgument:&amp;color atIndex:<span class="number">2</span>];</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.privateView];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.privateView methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> changeColor:[<span class="built_in">UIColor</span> redColor]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/9.png" alt=""></p>
<blockquote>
<p>由于执行到该消息转发的时候并没有缓存，所以每次都会执行。</p>
</blockquote>
<h4 id="methodSignatureForSelector"><a href="#methodSignatureForSelector" class="headerlink" title="methodSignatureForSelector"></a>methodSignatureForSelector</h4><p>To respond to methods that your object does not itself recognize, you must override methodSignatureForSelector: in addition to forwardInvocation:. The mechanism for forwarding messages uses information obtained from methodSignatureForSelector: to create the NSInvocation object to be forwarded. Your overriding method must provide an appropriate method signature for the given selector, either by pre formulating one or by asking another object for one.</p>
<p>在上面class_addMethod的时候出现了<code>&quot;v@:&quot;</code>东西。</p>
<ol>
<li>@encode(BOOL) (c) for the return type</li>
<li>@encode(id) (@) for the receiver (self)</li>
<li>@encode(SEL) (:) for the selector (_cmd)</li>
<li>@encode(NSString *) (@) for the first explicit argument</li>
</ol>
<p>每个方法都有两个默认的参数，一个是self，一个是_cmd。而那个字符串表示的就是类型编码（Type Encodings）。</p>
<p><code>&quot;v@:&quot;</code>表示的就是返回值为void，第一个参数是self，第二个参数为_cmd。</p>
<h3 id="doesNotRecognizeSelector"><a href="#doesNotRecognizeSelector" class="headerlink" title="doesNotRecognizeSelector"></a>doesNotRecognizeSelector</h3><p>当上面步骤都走完了，还是没有找到相关的消息接受者，就会调用NSObject的<code>doesNotRecognizeSelector</code>来抛出异常。既”Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason:”</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/8.png" alt=""></p>
<h2 id="Item-13-Method-Swizzling"><a href="#Item-13-Method-Swizzling" class="headerlink" title="Item 13: Method Swizzling"></a>Item 13: Method Swizzling</h2><p>在了解了消息转发之后，就很容易理解方法交换。就是修改Methos Lists。</p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/10.jpg" alt=""></p>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/11.jpg" alt=""></p>
<p>在这里我们需要注意的几点：</p>
<ol>
<li>为什么要在load中实现方法交换。</li>
<li>load和initialize调用时机。</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Begin"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"End"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ObjectA.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ObjectA</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)initialize &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"initialize"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newCreate &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/14.png" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Begin"</span>);</span><br><span class="line">    ObjectA *newCreate = [[ObjectA alloc] init];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"End"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/15.png" alt=""></p>
<p>load调用：</p>
<ol>
<li>Load在镜像加载的时候调用。</li>
<li>Load先于main调用，这个时候Framework已经加载了（C++静态库没有）。</li>
<li>父类先于子类调用。</li>
<li>类先于carthage调用。</li>
</ol>
<p>initlizate调用：</p>
<ol>
<li>第一次初始化类，或者是调用类方法等（个人理解就是创建元类的时候，因为元类也可以看成单例）。</li>
<li>如果没有调用则不会调用initlizate。</li>
</ol>
<blockquote>
<p><a href="https://github.com/Draveness/analyze/blob/master/contents/objc/%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%20load%20%E6%96%B9%E6%B3%95%E4%B9%88%EF%BC%9F.md" target="_blank" rel="noopener">你真的了解 load 方法么？</a></p>
</blockquote>
<h2 id="Item-14-Objective-C-Object"><a href="#Item-14-Objective-C-Object" class="headerlink" title="Item 14: Objective-C Object"></a>Item 14: Objective-C Object</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *string = <span class="string">@"This is NSString"</span>;</span><br></pre></td></tr></table></figure>
<p>这个是一个很简单的字符串</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>string</th>
<th>@”This is NSString”</th>
</tr>
</thead>
<tbody>
<tr>
<td>内存分配</td>
<td>栈</td>
<td>堆</td>
</tr>
<tr>
<td>类型</td>
<td>objc_object</td>
<td>objc_class</td>
</tr>
</tbody>
</table>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Class中的isa指向其元类，也是类方法定<!-- more --><!-- more -->义的地方，只有一个实例关联元类（可以认为类方法的调用类似于单例调用实例方法）。所以下面的判断方法是正确的。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> object = <span class="comment">/*...*/</span>;</span><br><span class="line"><span class="keyword">if</span> ([object <span class="keyword">class</span>] == [AClass <span class="keyword">class</span>]) &#123;</span><br><span class="line">    <span class="comment">// 'object' is an instance of AClass</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>⚠️ 这种方式仅对NSObject子类有效，如果类是继承于NSProxy，则不适用。</p>
</blockquote>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/12.jpg" alt=""></p>
<h1 id="Interface-and-API-Design"><a href="#Interface-and-API-Design" class="headerlink" title="Interface and API Design"></a>Interface and API Design</h1><h2 id="Item-18-Prefer-Immutable-Objects"><a href="#Item-18-Prefer-Immutable-Objects" class="headerlink" title="Item 18: Prefer Immutable Objects"></a>Item 18: Prefer Immutable Objects</h2><p>Swift中我觉得最好的是权限控制，由于Swift以文件为单位进行权限控制。例如<code>private</code>、<code>fileprivate</code>等。内部读写，外部读取我们可以使用<code>private(set)</code>、<code>fileprivate(set)</code>这样的方式。刚接触OC的时候很是困惑，直到我明白OC的动态性和Runtime等相关知识。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">A</span></span></span><br><span class="line"><span class="comment">/// 只读属性</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *string;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// A.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">A</span> ()</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">readwrite</span>) <span class="built_in">NSString</span> *string;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">   <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">       <span class="keyword">self</span>.string = <span class="string">@"Jack"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>下面提供个人的理解：</p>
<ol>
<li>Runtime的存在使得OC具有动态性，直到运行时才知道如何进行消息派发，在编译的时候是并不知道的。</li>
<li>头文件的作用就是告诉编译器我有这个方法，其他人可以尝试调用，但是有没有实现我并不告诉别人，直到运行时才告诉你。</li>
<li>Extension其实是在编译的时候进行的，目的就是隐藏具体的细节。</li>
</ol>
<blockquote>
<p>实现文件用来编译，头文件用来链接其他文件。</p>
</blockquote>
<p>我们再来分析上面的代码，在头文件声明属性，编译器会自动生成getString方法，其他人看到也就只有这个。在实现文件中声明相同属性，编译器会声明getString和setString两个方法，只有自己知道。所以也就实现了类似于Swift的内部读写，外部读取。但是这个setString方法在Runtime的是可以在方法表中找到的，意味着我们向其发送setString消息，是能够响应的（或者通过KVC）。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectA *a = [[ObjectA alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br><span class="line"><span class="comment">/// 向其发送setString消息，These functions must be cast to an appropriate function pointer type before being called.</span></span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="keyword">id</span>))objc_msgSend)(a, sel_registerName(<span class="string">"setString:"</span>), <span class="string">@"Sparrow"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br><span class="line">[a setValue:<span class="string">@"Jack"</span> forKey:<span class="string">@"string"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, a.string);</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/13.png" alt=""></p>
<h2 id="Advances"><a href="#Advances" class="headerlink" title="Advances"></a>Advances</h2><h3 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Basic Messaging Primitives</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_stret for some struct return types.</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_fpret for some float return types.</span></span><br><span class="line"><span class="comment"> * On some architectures, use objc_msgSend_fp2ret for some float return types.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These functions must be cast to an appropriate function pointer type </span></span><br><span class="line"><span class="comment"> * before being called. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#if !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line">OBJC_EXPORT <span class="keyword">void</span></span><br><span class="line">objc_msgSend(<span class="keyword">void</span> <span class="comment">/* id self, SEL op, ... */</span> )</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从objc_msgSend定义看出，其并不是一个具体的函数，而是在调用的时候需要给出指定的函数指针类型。</p>
</blockquote>
<p>下面我们看看编译器是如何为我们解决代码到消息的转换。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.h</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">   ObjectA *a = [[ObjectA alloc] init];</span><br><span class="line">   <span class="comment">/// 其实明并没有做任何事，仅仅在头文件声明，让编译器知道有这个方法</span></span><br><span class="line">   [a setA: <span class="string">@"Sparrow"</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> clang -rewrite-objc main.m</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.cpp</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">   ObjectA *a = ((ObjectA *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((ObjectA *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"ObjectA"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>));</span><br><span class="line">   ((<span class="keyword">void</span> (*)(<span class="keyword">id</span>, SEL, <span class="built_in">NSString</span> *))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)a, sel_registerName(<span class="string">"setA:"</span>), (<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_8j_r22m5hzd7lj4qz9prr3q1qlw0000gn_T_main_1cdde1_mi_0);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数指针类型是<code>(void (*)(id, SEL, NSString *)</code>，<code>sel_registerName</code>通过给定的<code>&quot;setA:&quot;</code>字符串生成一个SEL，之后是传递的参数。这样就实现了消息发送。</p>
<blockquote>
<p><a href="http://yaoqi-github.github.io/20160417/runtim-objc_msgSend%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">runtime objc_msgSend使用</a></p>
</blockquote>
<h3 id="Extension-Class-continuation-Category-amp-amp-Category"><a href="#Extension-Class-continuation-Category-amp-amp-Category" class="headerlink" title="Extension(Class-continuation Category) &amp;&amp; Category"></a>Extension(Class-continuation Category) &amp;&amp; Category</h3><ol>
<li>Extension（编译期间），Category（运行时期间）。<blockquote>
<p>所以Extension可以添加实例变量而Category不能。</p>
</blockquote>
</li>
<li>Extension和Category都可以添加属性。<blockquote>
<p>但是只有Extension可以自动生成对应的实例变量和存储方法，而Category不会生成实例变量和存储方法，只有一个存储方法的声明，需要自己去手动实现。<br>如果没有手动实现就会出现警告Property ‘privateString’ requires method ‘privateString’ to be defined - use @dynamic or provide a method implementation in this category</p>
</blockquote>
</li>
<li>如果Category添加的方法和原类中的方法是同名的，那么会覆盖（<strong>最后在运行时加载的时候Category的方法表会在原方法表前面，导致被覆盖的现象，其实原方法还是存在的</strong>）原有类中方法的实现。</li>
</ol>
<p>我们再来看看这个结构，则<code>objc_ivar_list</code>指向的是实例变量表，<code>objc_method_list</code>指向的实例方法表指针。两者的区别导致了我们只能在运行时动态修改实例方法表，而不能修改实例变量表。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_ivar &#123;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable ivar_type                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">int</span> ivar_offset                                          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_ivar_list &#123;</span><br><span class="line">    <span class="keyword">int</span> ivar_count                                           OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar ivar_list[<span class="number">1</span>]                            OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">char</span> * _Nullable method_types                            OBJC2_UNAVAILABLE;</span><br><span class="line">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_method_list &#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable obsolete             OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> method_count                                         OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>]                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在运行期，对象内存布局已经确定。</p>
</blockquote>
<p>从category中可以看出并不能添加实例变量。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> category_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    classref_t cls;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods;</span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;</span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;</span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">struct</span> property_list_t *_classProperties;</span><br><span class="line"></span><br><span class="line">    method_list_t *methodsForMeta(<span class="keyword">bool</span> isMeta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMeta) <span class="keyword">return</span> classMethods;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> instanceMethods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_list_t *propertiesForMeta(<span class="keyword">bool</span> isMeta, <span class="keyword">struct</span> header_info *hi);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="noopener">深入理解Objective-C：Category</a></p>
</blockquote>
<h1 id="Memory-Management"><a href="#Memory-Management" class="headerlink" title="Memory Management"></a>Memory Management</h1><h2 id="Item-30-ARC"><a href="#Item-30-ARC" class="headerlink" title="Item 30 ARC"></a>Item 30 ARC</h2><p>当方法名字是以下面名字为开头，则返回的对象交由调用者管理。如果不是，则返回的对象为autorelease对象。</p>
<ol>
<li>alloc</li>
<li>new</li>
<li>copy</li>
<li>mutableCopy</li>
</ol>
<p>举个🌰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ObjectA.m</span></span><br><span class="line"><span class="comment">/// 很简单，两个类方法，返回当前实例，注意命名</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ObjectA</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newCreate;  <span class="comment">// return [[self alloc] init];</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)create;     <span class="comment">// return [[self alloc] init];</span></span><br><span class="line">- (<span class="keyword">void</span>)testFunction;       <span class="comment">// NSLog(@"Test Function"); </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    ObjectA *newCreate = [ObjectA newCreate];</span><br><span class="line">    ObjectA *create = [ObjectA create];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用clang将ObjectA.m文件编译成LLVM中间文件。</span></span><br><span class="line">$ clang -S -fobjc-arc -emit-llvm ObjectA.m -o ObjectA.ll</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">define internal i8* @&quot;\01+[ObjectA newCreate]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %7 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %5, i8* %6)</span><br><span class="line">  %9 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %7, i8* %8)</span><br><span class="line">  ret i8* %11</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal i8* @&quot;\01+[ObjectA create]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %7 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %5, i8* %6)</span><br><span class="line">  %9 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %7, i8* %8)</span><br><span class="line">  %12 = tail call i8* @objc_autoreleaseReturnValue(i8* %11) #2</span><br><span class="line">  ret i8* %12</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用clang将main.m文件编译成LLVM中间文件。</span></span><br><span class="line">$ clang -S -fobjc-arc -emit-llvm main.m -o main.ll</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 &#123;</span><br><span class="line">  %11 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)</span><br><span class="line">  %16 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %15, i8* %14)</span><br><span class="line">  %17 = call i8* @objc_retainAutoreleasedReturnValue(i8* %16) #2</span><br><span class="line">  call void @objc_storeStrong(i8** %19, i8* null) #2</span><br><span class="line">  call void @objc_storeStrong(i8** %20, i8* null) #2</span><br><span class="line">  ret i32 %21</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我们可以看出同一个实例仅仅是命名不同，编译的结果是不一样的。<br>new开头的方法是直接返回对象的，意味着由调用者管理返回对象的内存，对象为<strong>strong类型，所以返回的对象引用计数为1。<br>非new开头的方法返回的是一个autorelease对象（引用计数为0），但是由于create对象为</strong>strong类型，所以做了一次objc_retainAutoreleasedReturnValue操作。<br>相同点是在函数结束的时候调用objc_storeStrong将对象释放。</p>
</blockquote>
<p>接下来我们看看这两个方法的实现，再结合书中的代码分析</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Same as objc_retainAutorelease but suitable for tail-calling </span></span><br><span class="line"><span class="comment">// if you don't want to push a frame before this point.</span></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="keyword">static</span> id </span><br><span class="line">objc_retainAutoreleaseAndReturn(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_retainAutorelease(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare a value at +1 for return through a +0 autoreleasing convention.</span></span><br><span class="line">id </span><br><span class="line">objc_autoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus1)) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare a value at +0 for return through a +0 autoreleasing convention.</span></span><br><span class="line">id </span><br><span class="line">objc_retainAutoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus0)) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// not objc_autoreleaseReturnValue(objc_retain(obj)) </span></span><br><span class="line">    <span class="comment">// because we don't need another optimization attempt</span></span><br><span class="line">    <span class="keyword">return</span> objc_retainAutoreleaseAndReturn(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">objc_retainAutorelease(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(objc_retain(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/1.jpg" alt=""></p>
<blockquote>
<p>在这里我们可以看出编译器对autorelease进行了优化。</p>
<ol>
<li>如果该对象返回的对象是__strong类型，则直接返回该对象。</li>
<li>如果该对象返回的对象是__weak类型，则返回的对象为autorelease对象。</li>
</ol>
</blockquote>
<h3 id="weak"><a href="#weak" class="headerlink" title="weak"></a>weak</h3><p>首先我们证实一下上面的问题。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main.m</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/// ⚠️ main.m:13:21: warning: assigning retained object to weak variable; object will be released after assignment。</span></span><br><span class="line">    ObjectA *__<span class="keyword">weak</span> newCreate = [ObjectA newCreate];</span><br><span class="line">    [newCreate testFunction];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    ObjectA *__<span class="keyword">weak</span> create = [ObjectA create];</span><br><span class="line">    [create testFunction];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 personality i8* bitcast (i32 (...)* @__objc_personality_v0 to i8*) &#123;</span><br><span class="line">  %12 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %11, i8* %10)</span><br><span class="line">  %16 = call i8* @objc_initWeak(i8** %14, i8* %15) #2</span><br><span class="line">  call void @objc_release(i8* %17) #2, !clang.imprecise_release !7</span><br><span class="line">  %19 = call i8* @objc_loadWeakRetained(i8** %18) #2</span><br><span class="line">  invoke void bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to void (i8*, i8*)*)(i8* %22, i8* %21)</span><br><span class="line">  ...</span><br><span class="line">  call void @objc_destroyWeak(i8** %25) #2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">define i32 @main(i32, i8**) #0 personality i8* bitcast (i32 (...)* @__objc_personality_v0 to i8*) &#123;</span><br><span class="line">  %12 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %11, i8* %10)</span><br><span class="line">  %13 = call i8* @objc_retainAutoreleasedReturnValue(i8* %12) #2</span><br><span class="line">  %17 = call i8* @objc_initWeak(i8** %15, i8* %16) #2</span><br><span class="line">  call void @objc_release(i8* %18) #2, !clang.imprecise_release !7</span><br><span class="line">  %20 = call i8* @objc_loadWeakRetained(i8** %19) #2</span><br><span class="line">  invoke void bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to void (i8*, i8*)*)(i8* %23, i8* %22)</span><br><span class="line">          to label %24 unwind label %28</span><br><span class="line">  ...</span><br><span class="line">  call void @objc_destroyWeak(i8** %25) #2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/2018-03-07-Effective-Objective-C-2-0/6.png" alt=""></p>
<blockquote>
<p>两个同样的实例一个有警告无任何的输出结果，一个没有警告，正常输出。</p>
<p>原因就在于第二个创建的实例是一个autorelease对象，而第一个创建的对象由于引用计数为0，所以一创建就被释放掉了。</p>
</blockquote>
<p><a href="http://luoxianming.cn/2017/05/06/arc/" target="_blank" rel="noopener">探究ARC</a></p>
<p><a href="https://clang.llvm.org/docs/AutomaticReferenceCounting.html" target="_blank" rel="noopener">Objective-C Automatic Reference Counting (ARC)</a></p>
<p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener">黑幕背后的Autorelease</a></p>

      
      
        <div class="page-reward">
          <p><a href="javascript:void(0)" onclick="dashangToggle()" class="dashang">赏</a></p>
          <div class="hide_box"></div>
          <div class="shang_box">
            <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
            <div class="shang_tit">
              <p>谢谢打赏</p>
            </div>
            <div class="shang_payimg">
              <img src="/img/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
            </div>
              <div class="pay_explain">扫码打赏，你说多少就多少</div>
            <div class="shang_payselect">
              
                <div class="pay_item checked" data-id="alipay">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/alipay.png" alt="支付宝" /></span>
                </div>
              
              
                <div class="pay_item" data-id="wechat">
                  <span class="radiobox"></span>
                  <span class="pay_logo"><img src="/img/weixin.png" alt="微信" /></span>
                </div>
              
            </div>
            <div class="shang_info">
              <p>打开<span id="shang_pay_txt">支付宝</span>扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
        </div>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script type="text/javascript">
          $(".pay_item").click(function(){
            $(this).addClass('checked').siblings('.pay_item').removeClass('checked');
            var dataid=$(this).attr('data-id');
            $(".shang_payimg img").attr("src","/img/"+dataid+"img.jpg");
            $("#shang_pay_txt").text(dataid=="alipay"?"支付宝":"微信");
          });
          function dashangToggle(){

            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
          }
        </script>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>Title:</span><a href="/2018/03/07/EffectiveObjectiveC20/">Effective Objective-C 2.0</a></p>
        <p><span>Author:</span><a href="/" title="访问 Mini灬哆啦 的个人博客">Mini灬哆啦</a></p>
        <p><span>Publish Time:</span>2018-03-07 10:31</p>
        <p><span>Update Time:</span>2018-04-11 23:31</p>
        <p>
            <span>Original Link:</span><a class="post-url" href="/2018/03/07/EffectiveObjectiveC20/" title="Effective Objective-C 2.0">http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/</a>
            <span class="copy-path" data-clipboard-text="原文: http://xwjack.github.io/2018/03/07/EffectiveObjectiveC20/　　作者: Mini灬哆啦" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a href="/2018/02/27/NewYearGoal/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">2018年目标</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Accustoming-Yourself-to-Objective-C"><span class="toc-number">1.</span> <span class="toc-text">Accustoming Yourself to Objective-C</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-4-Typed-Constants"><span class="toc-number">1.1.</span> <span class="toc-text">Item 4: Typed Constants</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Objects-Messaging-and-the-Runtime"><span class="toc-number">2.</span> <span class="toc-text">Objects, Messaging, and the Runtime</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-6-Understand-Properties"><span class="toc-number">2.1.</span> <span class="toc-text">Item 6: Understand Properties</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-9-Class-Cluster"><span class="toc-number">2.2.</span> <span class="toc-text">Item 9: Class Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-12-Message-Forwarding"><span class="toc-number">2.3.</span> <span class="toc-text">Item 12: Message Forwarding</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#resolveInstanceMethod-resolveClassMethod"><span class="toc-number">2.3.1.</span> <span class="toc-text">resolveInstanceMethod || resolveClassMethod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#forwardingTargetForSelector"><span class="toc-number">2.3.2.</span> <span class="toc-text">forwardingTargetForSelector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#forwardInvocation"><span class="toc-number">2.3.3.</span> <span class="toc-text">forwardInvocation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#methodSignatureForSelector"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">methodSignatureForSelector</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#doesNotRecognizeSelector"><span class="toc-number">2.3.4.</span> <span class="toc-text">doesNotRecognizeSelector</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-13-Method-Swizzling"><span class="toc-number">2.4.</span> <span class="toc-text">Item 13: Method Swizzling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-14-Objective-C-Object"><span class="toc-number">2.5.</span> <span class="toc-text">Item 14: Objective-C Object</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Interface-and-API-Design"><span class="toc-number">3.</span> <span class="toc-text">Interface and API Design</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-18-Prefer-Immutable-Objects"><span class="toc-number">3.1.</span> <span class="toc-text">Item 18: Prefer Immutable Objects</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Advances"><span class="toc-number">3.2.</span> <span class="toc-text">Advances</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#objc-msgSend"><span class="toc-number">3.2.1.</span> <span class="toc-text">objc_msgSend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extension-Class-continuation-Category-amp-amp-Category"><span class="toc-number">3.2.2.</span> <span class="toc-text">Extension(Class-continuation Category) &amp;&amp; Category</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Memory-Management"><span class="toc-number">4.</span> <span class="toc-text">Memory Management</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Item-30-ARC"><span class="toc-number">4.1.</span> <span class="toc-text">Item 30 ARC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#weak"><span class="toc-number">4.1.1.</span> <span class="toc-text">weak</span></a></li></ol></li></ol></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="Display or Hide">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>






<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
        <div id="gitments"></div>
<script src="/js/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
      id: window.location.pathname,
      owner: 'XWJACK',
      repo: 'xwjack.github.io',
      oauth: {
        client_id: '63a97a6fabe1ee5265d1',
        client_secret: 'b1fe01f8c1aed22c0e78e5b65ac4793bb1433707',
      },
    })
    gitment.render('gitments')
</script>
    



    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2018/02/27/NewYearGoal/" title="下一篇: 2018年目标">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/07/EffectiveObjectiveC20/">Effective Objective-C 2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/27/NewYearGoal/">2018年目标</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/02/LLDB/">LLDB</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/22/Terminal/">Terminal</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/18/VideoToolbox/">VideoToolbox</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/Camera/">Camera</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/10/LivePhoto/">Live Photo</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/08/Marco/">Marco</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/28/iOS/">iOS</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/21/XCTest/">XCTest</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/15/Reverse/">Reverse</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/25/GPUImage/">GPUImage</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/20/Framework/">Framework</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/31/Playback/">Playback</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/02/Lotus/">Lotus</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/Purchase/">iOS In-App Purchase</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/Music/">Music</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/Regex/">Regex</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/09/Build/">Build</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/06/Git/">Git</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/19/Swift-Source-Code-Analysis-Array/">Swift Source Code Analysis - Array</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/Swift-Source-Code-Analysis-Sort/">Swift Source Code Analysis - Sort</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2018 Mini灬哆啦
            </div>
            <div class="footer-right">
                <!-- <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman -->
            </div>
        </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-" + backgroundnum +".png)";
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80240532-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<!-- Baidu Analytics -->
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?4312600141d9e3d6b344aba925f03a57";
	  var s = document.getElementsByTagName("script")[0];
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
	<!-- End Baidu Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>